<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®­ç»ƒæ§åˆ¶å°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            font-size: 1.1em;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .card h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.8em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .icon {
            font-size: 1.2em;
        }

        .card-content {
            margin-top: 20px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin-top: 15px;
            font-weight: 600;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .status-panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .status-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1em;
        }

        .indicator-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #10b981;
            animation: pulse 2s infinite;
        }

        .indicator-dot.running {
            background: #f59e0b;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e5e7eb;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .logs-container {
            background: #1f2937;
            color: #10b981;
            border-radius: 8px;
            padding: 20px;
            max-height: 500px;
            min-height: 300px;
            overflow-y: auto;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 0.9em;
            line-height: 1.6;
        }

        .log-entry {
            margin: 4px 0;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .info-item {
            background: #f3f4f6;
            padding: 15px;
            border-radius: 8px;
        }

        .info-label {
            color: #6b7280;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .info-value {
            color: #111827;
            font-size: 1.2em;
            font-weight: 600;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 40px;
            max-width: 900px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        /* è‡ªå®šä¹‰å¯¹è¯æ¡† */
        .custom-dialog {
            max-width: 520px;
            padding: 0;
            overflow: hidden;
        }

        .dialog-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 24px;
            font-size: 1.2em;
            font-weight: 600;
        }

        .dialog-body {
            padding: 24px;
        }

        .dialog-message {
            font-size: 1em;
            color: #374151;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .dialog-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1em;
            box-sizing: border-box;
            margin-bottom: 20px;
            transition: border-color 0.3s;
        }

        .dialog-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .dialog-buttons {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .dialog-btn {
            padding: 10px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .dialog-btn-cancel {
            background: #f3f4f6;
            color: #6b7280;
        }

        .dialog-btn-cancel:hover {
            background: #e5e7eb;
        }

        .dialog-btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .dialog-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .dialog-btn-secondary {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .dialog-btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        .dialog-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }

        .dialog-option {
            padding: 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }

        .dialog-option:hover {
            border-color: #667eea;
            background: #f9fafb;
        }

        .dialog-option.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
        }

        .dialog-option-title {
            font-weight: 600;
            color: #374151;
            margin-bottom: 4px;
        }

        .dialog-option-desc {
            font-size: 0.9em;
            color: #6b7280;
        }

        .close-btn {
            float: right;
            font-size: 2em;
            cursor: pointer;
            color: #6b7280;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: 500;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
        }

        .alert-error {
            background: #fee2e2;
            color: #991b1b;
        }

        .alert-warning {
            background: #fef3c7;
            color: #92400e;
        }

        .directory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .directory-section {
            background: #f9fafb;
            border-radius: 8px;
            padding: 15px;
        }

        .directory-section h3 {
            color: #374151;
            font-size: 1.1em;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .directory-path {
            font-family: 'Monaco', monospace;
            font-size: 0.85em;
            color: #6b7280;
            margin-bottom: 10px;
        }

        .file-list {
            list-style: none;
            padding: 0;
        }

        .file-item {
            padding: 8px 0;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-item:last-child {
            border-bottom: none;
        }

        .file-name {
            font-family: 'Monaco', monospace;
            font-size: 0.9em;
            color: #111827;
        }

        .file-meta {
            font-size: 0.85em;
            color: #6b7280;
        }

        .eval-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: 600;
            margin-left: 8px;
        }

        .eval-badge-success {
            background: #d1fae5;
            color: #065f46;
        }

        .eval-badge-info {
            background: #dbeafe;
            color: #1e40af;
        }

        .btn-eval {
            padding: 4px 12px;
            font-size: 0.85em;
            margin-left: 8px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        /* Configuration Display Styles */
        .config-categories {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .config-category {
            background: #f9fafb;
            border-radius: 12px;
            padding: 16px;
            border: 2px solid #e5e7eb;
        }

        .config-category-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            font-weight: 600;
            color: #111827;
            font-size: 1.05em;
        }

        .config-category-icon {
            font-size: 1.2em;
        }

        .config-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .config-item:last-child {
            border-bottom: none;
        }

        .config-label {
            color: #6b7280;
            font-size: 0.9em;
        }

        .config-value {
            color: #111827;
            font-weight: 500;
        }

        /* Configuration Edit Mode */
        .config-edit-form {
            display: none;
        }

        .config-edit-form.active {
            display: block;
        }

        .config-form-group {
            margin-bottom: 12px;
        }

        .config-form-label {
            display: block;
            color: #374151;
            font-weight: 500;
            margin-bottom: 4px;
            font-size: 0.9em;
        }

        .config-form-input {
            width: 100%;
            padding: 8px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            font-size: 0.9em;
        }

        .config-form-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .config-form-checkbox {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .config-form-checkbox input {
            width: 16px;
            height: 16px;
        }

        .config-form-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1>è®­ç»ƒæ§åˆ¶å°</h1>
                    <p class="subtitle">ä»»åŠ¡: <strong>{{ task_id }}</strong></p>
                </div>
                <button class="btn" onclick="window.location.href='/'" style="background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);">
                    â† è¿”å›ä»»åŠ¡åˆ—è¡¨
                </button>
            </div>
        </header>

        <!-- Directory Info & Evaluation -->
        <div class="card" style="grid-column: 1 / -1; margin-bottom: 20px;">
            <h2><span class="icon">ğŸ“</span> ä»»åŠ¡æ•°æ®</h2>
            <div id="directory-info" style="margin-top: 20px;">
                åŠ è½½ä¸­...
            </div>
        </div>

        <!-- Task Configuration -->
        <div class="card" style="grid-column: 1 / -1; margin-bottom: 40px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2><span class="icon">âš™ï¸</span> ä»»åŠ¡é…ç½®</h2>
                <button class="btn btn-secondary" id="edit-config-btn" onclick="toggleConfigEdit()">
                    ğŸ“ ç¼–è¾‘é…ç½®
                </button>
            </div>
            <div id="config-display">
                åŠ è½½ä¸­...
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- åŠŸèƒ½1ï¼šå½•åˆ¶å’Œè®­ç»ƒåŸºçº¿ -->
            <div class="card">
                <h2><span class="icon">ğŸ“¹</span> å½•åˆ¶ä¸“å®¶æ¼”ç¤º</h2>
                <p style="color: #666; margin-bottom: 20px;">
                    æ­¥éª¤ï¼šå½•åˆ¶æ¼”ç¤º â†’ è®­ç»ƒBCåŸºçº¿ â†’ è¯„ä¼°æ•ˆæœ
                </p>
                
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">å½•åˆ¶Episodes</div>
                        <div class="info-value" id="expert-episodes">10</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">è®­ç»ƒEpochs</div>
                        <div class="info-value" id="bc-epochs">50</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">è®¾å¤‡</div>
                        <div class="info-value" id="device">MPS</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">æœ€å¤§æ­¥æ•°</div>
                        <div class="info-value" id="max-steps">1000</div>
                    </div>
                </div>

                <button class="btn" id="btn-record-train" onclick="startRecordAndTrain()">
                    ğŸš€ å¼€å§‹å½•åˆ¶å¹¶è®­ç»ƒ
                </button>
            </div>

            <!-- åŠŸèƒ½2ï¼šDAggerè¿­ä»£ -->
            <div class="card">
                <h2><span class="icon">ğŸ”„</span> DAgger è¿­ä»£è®­ç»ƒ</h2>
                <p style="color: #666; margin-bottom: 20px;">
                    å¾ªç¯ï¼šæ”¶é›†å¤±è´¥ â†’ æ ‡æ³¨ â†’ è®­ç»ƒ â†’ è¯„ä¼°
                </p>
                
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">å½“å‰è¿­ä»£</div>
                        <div class="info-value" id="current-iteration">0</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">æ”¶é›†Episodes</div>
                        <div class="info-value" id="collect-episodes">20</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">è®­ç»ƒEpochs</div>
                        <div class="info-value" id="dagger-epochs">30</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">è¯„ä¼°Episodes</div>
                        <div class="info-value" id="eval-episodes">20</div>
                    </div>
                </div>

                <button class="btn btn-secondary" id="btn-dagger-iter" onclick="startDaggerIteration()">
                    âš¡ å¼€å§‹DAggerè¿­ä»£
                </button>
            </div>
        </div>

        <!-- Status Panel -->
        <div class="status-panel">
            <div class="status-header">
                <h2>ğŸ“Š è¿è¡ŒçŠ¶æ€</h2>
                <div class="status-indicator">
                    <div class="indicator-dot" id="status-dot"></div>
                    <span id="status-text">å°±ç»ª</span>
                </div>
            </div>

            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill" style="width: 0%;">0%</div>
            </div>

            <div id="current-stage" style="margin: 15px 0; font-size: 1.1em; color: #374151;"></div>

            <!-- åœæ­¢æŒ‰é’® -->
            <button id="stop-btn" class="btn" style="display: none; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); margin-bottom: 15px; width: 100%;" onclick="stopTask()">
                â¹ï¸ åœæ­¢ä»»åŠ¡
            </button>

            <div class="logs-container" id="logs-container">
                <div class="log-entry">ç­‰å¾…ä»»åŠ¡å¼€å§‹...</div>
            </div>
        </div>
    </div>

    <!-- é€šç”¨å¯¹è¯æ¡† -->
    <div class="modal" id="custom-dialog">
        <div class="modal-content custom-dialog">
            <div class="dialog-header" id="dialog-header"></div>
            <div class="dialog-body">
                <div class="dialog-message" id="dialog-message"></div>
                <div id="dialog-content"></div>
                <div class="dialog-buttons" id="dialog-buttons"></div>
            </div>
        </div>
    </div>

    <script>
        // ä»»åŠ¡é…ç½®
        const TASK_ID = '{{ task_id }}';
        const CONFIG = {{ config | tojson }};
        
        // å…¨å±€çŠ¶æ€
        let currentIteration = 0;
        
        // è®¾ç½®å½“å‰ä»»åŠ¡
        async function setCurrentTask() {
            try {
                await fetch('/api/current_task', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({task_id: TASK_ID})
                });
            } catch (error) {
                console.error('è®¾ç½®å½“å‰ä»»åŠ¡å¤±è´¥:', error);
            }
        }

        // åˆå§‹åŒ–
        async function init() {
            await setCurrentTask();
            await loadDirectoryInfo();
            await updateStatus();
            await loadIterations();
            loadConfig();
            setInterval(updateStatus, 2000);
            setInterval(loadDirectoryInfo, 10000);  // æ¯10ç§’åˆ·æ–°ç›®å½•ä¿¡æ¯
        }
        
        // åŠ è½½é…ç½®åˆ°ç•Œé¢
        function loadConfig() {
            document.getElementById('expert-episodes').textContent = CONFIG.expert_episodes || CONFIG.num_expert_episodes || 10;
            document.getElementById('bc-epochs').textContent = CONFIG.bc_epochs || 50;
            document.getElementById('device').textContent = (CONFIG.device || 'MPS').toUpperCase();
            document.getElementById('max-steps').textContent = CONFIG.max_steps || 1000;
            document.getElementById('collect-episodes').textContent = CONFIG.collect_episodes || 20;
            document.getElementById('dagger-epochs').textContent = CONFIG.dagger_epochs || 30;
            document.getElementById('eval-episodes').textContent = CONFIG.eval_episodes || 20;
            
            // åŠ è½½å®Œæ•´é…ç½®æ˜¾ç¤º
            renderConfigDisplay();
        }

        // æ¸²æŸ“é…ç½®æ˜¾ç¤º
        async function renderConfigDisplay() {
            const container = document.getElementById('config-display');
            
            try {
                const response = await fetch('/api/config_template');
                const template = await response.json();
                
                let html = '<div class="config-categories">';
                
                template.categories.forEach(category => {
                    html += `
                        <div class="config-category">
                            <div class="config-category-header">
                                <span class="config-category-icon">${category.icon}</span>
                                <span>${category.name}</span>
                            </div>
                            <div>
                    `;
                    
                    category.fields.forEach(fieldId => {
                        const field = template.fields[fieldId];
                        if (!field) return;
                        
                        let value = CONFIG[fieldId];
                        if (value === undefined || value === null) {
                            value = template.default_config[fieldId];
                        }
                        
                        // æ ¼å¼åŒ–æ˜¾ç¤ºå€¼
                        let displayValue = value;
                        if (typeof value === 'boolean') {
                            displayValue = value ? 'âœ“ æ˜¯' : 'âœ— å¦';
                        } else if (fieldId === 'device') {
                            displayValue = String(value).toUpperCase();
                        }
                        
                        html += `
                            <div class="config-item">
                                <span class="config-label">${field.label}</span>
                                <span class="config-value">${displayValue}</span>
                            </div>
                        `;
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                
                // æ·»åŠ ç¼–è¾‘è¡¨å•ï¼ˆéšè—ï¼‰
                html += '<div class="config-edit-form" id="config-edit-form">';
                html += '<div class="config-categories">';
                
                template.categories.forEach(category => {
                    html += `
                        <div class="config-category">
                            <div class="config-category-header">
                                <span class="config-category-icon">${category.icon}</span>
                                <span>${category.name}</span>
                            </div>
                            <div>
                    `;
                    
                    category.fields.forEach(fieldId => {
                        const field = template.fields[fieldId];
                        if (!field) return;
                        
                        let value = CONFIG[fieldId];
                        if (value === undefined || value === null) {
                            value = template.default_config[fieldId];
                        }
                        
                        html += `<div class="config-form-group">`;
                        
                        if (field.type === 'checkbox') {
                            html += `
                                <div class="config-form-checkbox">
                                    <input type="checkbox" id="edit-${fieldId}" ${value ? 'checked' : ''}>
                                    <label for="edit-${fieldId}" class="config-form-label">${field.label}</label>
                                </div>
                            `;
                        } else {
                            html += `<label class="config-form-label">${field.label}</label>`;
                            
                            if (field.type === 'select') {
                                html += `<select class="config-form-input" id="edit-${fieldId}">`;
                                field.options.forEach(opt => {
                                    html += `<option value="${opt}" ${opt === value ? 'selected' : ''}>${opt}</option>`;
                                });
                                html += `</select>`;
                            } else if (field.type === 'number') {
                                const min = field.min !== undefined ? `min="${field.min}"` : '';
                                const max = field.max !== undefined ? `max="${field.max}"` : '';
                                const step = field.step !== undefined ? `step="${field.step}"` : '';
                                html += `<input type="number" class="config-form-input" id="edit-${fieldId}" 
                                              value="${value}" ${min} ${max} ${step}>`;
                            } else {
                                html += `<input type="text" class="config-form-input" id="edit-${fieldId}" value="${value}">`;
                            }
                        }
                        
                        html += `</div>`;
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                html += `
                    <div class="config-form-actions">
                        <button class="btn" onclick="saveConfig()" style="flex: 1;">ğŸ’¾ ä¿å­˜é…ç½®</button>
                        <button class="btn btn-secondary" onclick="cancelConfigEdit()" style="flex: 1;">âŒ å–æ¶ˆ</button>
                    </div>
                `;
                html += '</div>';
                
                container.innerHTML = html;
                
            } catch (error) {
                console.error('æ¸²æŸ“é…ç½®å¤±è´¥:', error);
                container.innerHTML = '<div class="alert alert-error">åŠ è½½é…ç½®å¤±è´¥</div>';
            }
        }

        // åˆ‡æ¢é…ç½®ç¼–è¾‘æ¨¡å¼
        function toggleConfigEdit() {
            const displayDiv = document.querySelector('#config-display > .config-categories');
            const editForm = document.getElementById('config-edit-form');
            const btn = document.getElementById('edit-config-btn');
            
            if (editForm.classList.contains('active')) {
                // å–æ¶ˆç¼–è¾‘
                cancelConfigEdit();
            } else {
                // è¿›å…¥ç¼–è¾‘æ¨¡å¼
                displayDiv.style.display = 'none';
                editForm.classList.add('active');
                btn.textContent = 'âŒ å–æ¶ˆç¼–è¾‘';
            }
        }

        // å–æ¶ˆé…ç½®ç¼–è¾‘
        function cancelConfigEdit() {
            const displayDiv = document.querySelector('#config-display > .config-categories');
            const editForm = document.getElementById('config-edit-form');
            const btn = document.getElementById('edit-config-btn');
            
            displayDiv.style.display = 'grid';
            editForm.classList.remove('active');
            btn.textContent = 'ğŸ“ ç¼–è¾‘é…ç½®';
        }

        // ä¿å­˜é…ç½®
        async function saveConfig() {
            try {
                // æ”¶é›†æ‰€æœ‰ç¼–è¾‘çš„å­—æ®µ
                const response = await fetch('/api/config_template');
                const template = await response.json();
                
                const updatedConfig = {};
                
                template.categories.forEach(category => {
                    category.fields.forEach(fieldId => {
                        const field = template.fields[fieldId];
                        if (!field) return;
                        
                        const input = document.getElementById(`edit-${fieldId}`);
                        if (!input) return;
                        
                        if (field.type === 'checkbox') {
                            updatedConfig[fieldId] = input.checked;
                        } else if (field.type === 'number') {
                            updatedConfig[fieldId] = parseFloat(input.value) || 0;
                        } else {
                            updatedConfig[fieldId] = input.value;
                        }
                    });
                });
                
                // å‘é€æ›´æ–°è¯·æ±‚
                const saveResponse = await fetch(`/api/tasks/${TASK_ID}/config`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(updatedConfig)
                });
                
                const data = await saveResponse.json();
                
                if (data.success) {
                    await showAlert('âœ… é…ç½®å·²ä¿å­˜', 'é…ç½®å·²æˆåŠŸæ›´æ–°ï¼');
                    
                    // æ›´æ–°å…¨å±€é…ç½®
                    Object.assign(CONFIG, updatedConfig);
                    
                    // é‡æ–°æ¸²æŸ“æ˜¾ç¤º
                    await renderConfigDisplay();
                    
                    // æ›´æ–°å…¶ä»–åœ°æ–¹æ˜¾ç¤ºçš„é…ç½®å€¼
                    loadConfig();
                    
                    // å–æ¶ˆç¼–è¾‘æ¨¡å¼
                    cancelConfigEdit();
                } else {
                    await showAlert('âŒ ä¿å­˜å¤±è´¥', data.error);
                }
            } catch (error) {
                await showAlert('âŒ ä¿å­˜å¤±è´¥', error.message);
            }
        }
        
        // åŠ è½½ç›®å½•ä¿¡æ¯
        async function loadDirectoryInfo() {
            try {
                const response = await fetch(`/api/tasks/${TASK_ID}/directory`);
                const data = await response.json();
                
                if (data.error) {
                    document.getElementById('directory-info').innerHTML = 
                        `<div class="alert alert-error">${data.error}</div>`;
                    return;
                }
                
                let html = '<div class="directory-grid">';
                
                // BCåŸºçº¿æ¨¡å‹
                html += '<div class="directory-section">';
                html += '<h3>ğŸ¯ BCåŸºçº¿æ¨¡å‹</h3>';
                html += `<div class="directory-path">${data.baseline_model.path}</div>`;
                
                if (data.baseline_model.models.length > 0) {
                    html += '<ul class="file-list">';
                    data.baseline_model.models.forEach(model => {
                        html += '<li class="file-item">';
                        html += '<div>';
                        html += `<div class="file-name">${model.name}</div>`;
                        html += `<div class="file-meta">${model.size} | ${model.modified}</div>`;
                        if (model.eval_result) {
                            html += `<span class="eval-badge eval-badge-success">æˆåŠŸç‡: ${model.eval_result.success_rate}</span>`;
                            html += `<span class="eval-badge eval-badge-info">å¹³å‡æ­¥æ•°: ${model.eval_result.avg_steps}</span>`;
                        }
                        html += '</div>';
                        html += `<button class="btn btn-eval" onclick="evaluateModel('${model.name}')">ğŸ“Š è¯„ä¼°</button>`;
                        html += '</li>';
                    });
                    html += '</ul>';
                } else {
                    html += '<p style="color: #9ca3af;">æš‚æ— åŸºçº¿æ¨¡å‹</p>';
                }
                html += '</div>';
                
                // DAggerè¿­ä»£æ¨¡å‹
                html += '<div class="directory-section">';
                html += '<h3>ğŸ”„ DAggerè¿­ä»£æ¨¡å‹</h3>';
                html += `<div class="directory-path">${data.dagger_model.path}</div>`;
                
                if (data.dagger_model.models.length > 0) {
                    html += '<ul class="file-list">';
                    data.dagger_model.models.forEach(model => {
                        html += '<li class="file-item">';
                        html += '<div>';
                        html += `<div class="file-name">${model.name}</div>`;
                        html += `<div class="file-meta">${model.size} | ${model.modified}</div>`;
                        if (model.eval_result) {
                            html += `<span class="eval-badge eval-badge-success">æˆåŠŸç‡: ${model.eval_result.success_rate}</span>`;
                            html += `<span class="eval-badge eval-badge-info">å¹³å‡æ­¥æ•°: ${model.eval_result.avg_steps}</span>`;
                        }
                        html += '</div>';
                        html += `<button class="btn btn-eval" onclick="evaluateModel('${model.name}')">ğŸ“Š è¯„ä¼°</button>`;
                        html += '</li>';
                    });
                    html += '</ul>';
                } else {
                    html += '<p style="color: #9ca3af;">æš‚æ— è¿­ä»£æ¨¡å‹</p>';
                }
                html += '</div>';
                
                // Expert Demos (ç®€åŒ–æ˜¾ç¤º)
                html += '<div class="directory-section">';
                html += '<h3>ğŸ“¹ ä¸“å®¶æ¼”ç¤º</h3>';
                html += `<div class="directory-path">${data.expert_demos.path}</div>`;
                
                const episodeCount = data.expert_demos.episodes.filter(ep => !ep.name.includes('...')).length;
                if (episodeCount > 0) {
                    html += '<div style="padding: 15px; text-align: center;">';
                    html += `<div style="font-size: 2em; color: #10b981; font-weight: bold;">${episodeCount}</div>`;
                    html += '<div style="color: #6b7280; margin-top: 5px;">ä¸ª episodes</div>';
                    html += '</div>';
                } else {
                    html += '<p style="color: #9ca3af;">æš‚æ— æ¼”ç¤º</p>';
                }
                html += '</div>';
                
                // Expert Labels
                html += '<div class="directory-section">';
                html += '<h3>ğŸ·ï¸ ä¸“å®¶æ ‡æ³¨</h3>';
                html += `<div class="directory-path">${data.expert_labels.path}</div>`;
                
                if (data.expert_labels.files.length > 0) {
                    html += '<ul class="file-list">';
                    data.expert_labels.files.forEach(file => {
                        // æå–è¿­ä»£ç¼–å·
                        const iterMatch = file.name.match(/iter_(\d+)\.pkl/);
                        const iterNum = iterMatch ? iterMatch[1] : null;
                        
                        html += '<li class="file-item">';
                        html += '<div>';
                        html += `<div class="file-name">${file.name}</div>`;
                        html += `<div class="file-meta">${file.size}</div>`;
                        html += '</div>';
                        
                        if (iterNum) {
                            html += `<button class="btn btn-eval" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);" onclick="relabelIteration(${iterNum})">ğŸ”„ é‡æ–°æ ‡æ³¨</button>`;
                        }
                        html += '</li>';
                    });
                    html += '</ul>';
                } else {
                    html += '<p style="color: #9ca3af;">æš‚æ— æ ‡æ³¨</p>';
                }
                html += '</div>';
                
                // Policy States
                html += '<div class="directory-section">';
                html += '<h3>ğŸ“¦ ç­–ç•¥çŠ¶æ€</h3>';
                html += `<div class="directory-path">${data.policy_states.path}</div>`;
                
                if (data.policy_states.iterations.length > 0) {
                    html += '<ul class="file-list">';
                    data.policy_states.iterations.forEach(iter => {
                        html += '<li class="file-item">';
                        html += `<span class="file-name">${iter.name}</span>`;
                        html += `<span class="file-meta">${iter.states} çŠ¶æ€</span>`;
                        html += '</li>';
                    });
                    html += '</ul>';
                } else {
                    html += '<p style="color: #9ca3af;">æš‚æ— çŠ¶æ€</p>';
                }
                html += '</div>';
                
                // Dagger Data
                html += '<div class="directory-section">';
                html += '<h3>ğŸ”„ DAggeræ•°æ®</h3>';
                html += `<div class="directory-path">${data.dagger.path}</div>`;
                
                if (data.dagger.files.length > 0) {
                    html += '<ul class="file-list">';
                    data.dagger.files.forEach(file => {
                        html += '<li class="file-item">';
                        html += `<span class="file-name">${file.name}</span>`;
                        html += `<span class="file-meta">${file.size}</span>`;
                        html += '</li>';
                    });
                    html += '</ul>';
                } else {
                    html += '<p style="color: #9ca3af;">æš‚æ— æ•°æ®</p>';
                }
                html += '</div>';
                
                html += '</div>';
                
                document.getElementById('directory-info').innerHTML = html;
                
            } catch (error) {
                console.error('åŠ è½½ç›®å½•ä¿¡æ¯å¤±è´¥:', error);
                document.getElementById('directory-info').innerHTML = 
                    `<div class="alert alert-error">åŠ è½½å¤±è´¥: ${error.message}</div>`;
            }
        }
        
        // ============================================================================
        // è‡ªå®šä¹‰å¯¹è¯æ¡†
        // ============================================================================

        function showDialog(title, message, options) {
            return new Promise((resolve) => {
                const dialog = document.getElementById('custom-dialog');
                const header = document.getElementById('dialog-header');
                const msg = document.getElementById('dialog-message');
                const content = document.getElementById('dialog-content');
                const buttons = document.getElementById('dialog-buttons');

                header.textContent = title;
                msg.textContent = message;
                content.innerHTML = '';
                buttons.innerHTML = '';

                if (options.type === 'input') {
                    const input = document.createElement('input');
                    input.className = 'dialog-input';
                    input.type = 'number';
                    input.value = options.defaultValue || '';
                    input.placeholder = options.placeholder || '';
                    content.appendChild(input);

                    input.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            const value = input.value;
                            dialog.classList.remove('active');
                            resolve(value || null);
                        }
                    });

                    setTimeout(() => input.focus(), 100);
                }

                if (options.type === 'choice') {
                    const optionsContainer = document.createElement('div');
                    optionsContainer.className = 'dialog-options';

                    options.choices.forEach((choice, index) => {
                        const optionDiv = document.createElement('div');
                        optionDiv.className = 'dialog-option';
                        if (index === 0) optionDiv.classList.add('selected');

                        optionDiv.innerHTML = `
                            <div class="dialog-option-title">${choice.title}</div>
                            <div class="dialog-option-desc">${choice.description}</div>
                        `;

                        optionDiv.addEventListener('click', () => {
                            document.querySelectorAll('.dialog-option').forEach(o => o.classList.remove('selected'));
                            optionDiv.classList.add('selected');
                        });

                        optionsContainer.appendChild(optionDiv);
                    });

                    content.appendChild(optionsContainer);
                }

                // æ·»åŠ æŒ‰é’®
                if (options.buttons) {
                    options.buttons.forEach(btn => {
                        const button = document.createElement('button');
                        button.className = `dialog-btn dialog-btn-${btn.type || 'primary'}`;
                        button.textContent = btn.text;
                        button.addEventListener('click', () => {
                            dialog.classList.remove('active');

                            if (options.type === 'input') {
                                const input = content.querySelector('input');
                                resolve(btn.value === 'confirm' ? input.value : null);
                            } else if (options.type === 'choice') {
                                const selected = content.querySelector('.dialog-option.selected');
                                const selectedIndex = Array.from(selected.parentNode.children).indexOf(selected);
                                resolve(btn.value === 'confirm' ? options.choices[selectedIndex].value : null);
                            } else {
                                resolve(btn.value);
                            }
                        });
                        buttons.appendChild(button);
                    });
                }

                dialog.classList.add('active');

                // ç‚¹å‡»èƒŒæ™¯å…³é—­
                dialog.addEventListener('click', (e) => {
                    if (e.target === dialog) {
                        dialog.classList.remove('active');
                        resolve(null);
                    }
                });
            });
        }

        function showAlert(title, message) {
            return showDialog(title, message, {
                buttons: [
                    { text: 'ç¡®å®š', type: 'primary', value: true }
                ]
            });
        }

        function showConfirm(title, message) {
            return showDialog(title, message, {
                buttons: [
                    { text: 'å–æ¶ˆ', type: 'cancel', value: false },
                    { text: 'ç¡®å®š', type: 'primary', value: true }
                ]
            });
        }

        // ============================================================================
        // é¡µé¢åŠŸèƒ½
        // ============================================================================

        // é‡æ–°æ ‡æ³¨è¿­ä»£
        async function relabelIteration(iterNum) {
            const confirmed = await showConfirm(
                'ğŸ”„ é‡æ–°æ ‡æ³¨è¿­ä»£',
                `ç¡®å®šè¦åˆ é™¤è¿­ä»£ ${iterNum} çš„ä¸“å®¶æ ‡æ³¨æ•°æ®å—ï¼Ÿ\n\nåˆ é™¤åå¯ä»¥ä½¿ç”¨ label_states.py é‡æ–°æ ‡æ³¨è¯¥è¿­ä»£çš„çŠ¶æ€ã€‚`
            );
            
            if (!confirmed) {
                return;
            }
            
            try {
                const response = await fetch(`/api/tasks/${TASK_ID}/relabel_iteration`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        iteration: iterNum
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    await showAlert('âœ… æ ‡æ³¨å·²æ¸…é™¤', data.message);
                    await loadDirectoryInfo();  // åˆ·æ–°ç›®å½•ä¿¡æ¯
                } else {
                    await showAlert('âŒ æ¸…é™¤å¤±è´¥', data.error);
                }
            } catch (error) {
                await showAlert('âŒ è¯·æ±‚å¤±è´¥', error.message);
            }
        }
        
        // è¯„ä¼°æ¨¡å‹
        async function evaluateModel(modelName) {
            // å¼¹å‡ºå¯¹è¯æ¡†è®¾ç½®è¯„ä¼°æ¬¡æ•°
            const episodes = await showDialog(
                'ğŸ“Š è¯„ä¼°æ¨¡å‹',
                `æ¨¡å‹: ${modelName}`,
                {
                    type: 'input',
                    defaultValue: CONFIG.eval_episodes || 20,
                    placeholder: 'è¯·è¾“å…¥è¯„ä¼°æ¬¡æ•°ï¼ˆEpisodesï¼‰',
                    buttons: [
                        { text: 'å–æ¶ˆ', type: 'cancel', value: null },
                        { text: 'å¼€å§‹è¯„ä¼°', type: 'primary', value: 'confirm' }
                    ]
                }
            );
            
            if (!episodes) {
                return;  // ç”¨æˆ·å–æ¶ˆ
            }
            
            const episodesNum = parseInt(episodes);
            if (isNaN(episodesNum) || episodesNum <= 0) {
                await showAlert('âŒ è¾“å…¥é”™è¯¯', 'è¯·è¾“å…¥æœ‰æ•ˆçš„æ­£æ•´æ•°ï¼');
                return;
            }
            
            try {
                const response = await fetch(`/api/tasks/${TASK_ID}/evaluate`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        model_name: modelName,
                        episodes: episodesNum
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    await showAlert('âœ… è¯„ä¼°å·²å¯åŠ¨', `æ¨¡å‹: ${modelName}\nEpisodes: ${episodesNum}\n\nè¯·æŸ¥çœ‹æ—¥å¿—è¾“å‡ºã€‚`);
                } else {
                    await showAlert('âŒ å¯åŠ¨å¤±è´¥', data.error);
                }
            } catch (error) {
                await showAlert('âŒ è¯·æ±‚å¤±è´¥', error.message);
            }
        }
        
        // åœæ­¢å½“å‰ä»»åŠ¡
        async function stopTask() {
            const confirmed = await showConfirm('â¹ï¸ åœæ­¢ä»»åŠ¡', 'ç¡®å®šè¦åœæ­¢å½“å‰è¿è¡Œçš„ä»»åŠ¡å—ï¼Ÿ');
            if (!confirmed) {
                return;
            }
            
            try {
                const response = await fetch('/api/stop', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });
                
                const data = await response.json();
                
                if (data.success) {
                    await showAlert('âœ… ä»»åŠ¡å·²åœæ­¢', 'ä»»åŠ¡å·²æˆåŠŸç»ˆæ­¢ã€‚');
                } else {
                    await showAlert('âŒ åœæ­¢å¤±è´¥', data.error || 'æœªçŸ¥é”™è¯¯');
                }
            } catch (error) {
                await showAlert('âŒ è¯·æ±‚å¤±è´¥', error.message);
            }
        }

        // æ›´æ–°çŠ¶æ€
        async function updateStatus() {
            try {
                const response = await fetch('/api/status');
                const status = await response.json();

                // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
                const dot = document.getElementById('status-dot');
                const text = document.getElementById('status-text');
                const stopBtn = document.getElementById('stop-btn');
                
                if (status.running) {
                    dot.classList.add('running');
                    text.textContent = 'è¿è¡Œä¸­';
                    document.getElementById('btn-record-train').disabled = true;
                    document.getElementById('btn-dagger-iter').disabled = true;
                    stopBtn.style.display = 'block';  // æ˜¾ç¤ºåœæ­¢æŒ‰é’®
                } else {
                    dot.classList.remove('running');
                    text.textContent = 'å°±ç»ª';
                    document.getElementById('btn-record-train').disabled = false;
                    document.getElementById('btn-dagger-iter').disabled = false;
                    stopBtn.style.display = 'none';   // éšè—åœæ­¢æŒ‰é’®
                }

                // æ›´æ–°è¿›åº¦
                const progress = status.progress || 0;
                const fill = document.getElementById('progress-fill');
                fill.style.width = progress + '%';
                fill.textContent = progress + '%';

                // æ›´æ–°é˜¶æ®µ
                const stageMap = {
                    'recording': 'ğŸ“¹ å½•åˆ¶ä¸“å®¶æ¼”ç¤º',
                    'training_bc': 'ğŸ“ è®­ç»ƒBCåŸºçº¿',
                    'evaluating': 'ğŸ“Š è¯„ä¼°ç­–ç•¥',
                    'collecting': 'ğŸ“¦ æ”¶é›†å¤±è´¥çŠ¶æ€',
                    'labeling': 'ğŸ·ï¸ ç­‰å¾…æ ‡æ³¨',
                    'training': 'ğŸš€ è®­ç»ƒæ¨¡å‹',
                    'completed': 'âœ… å®Œæˆ'
                };
                
                document.getElementById('current-stage').textContent = 
                    stageMap[status.stage] || status.message;

                // æ›´æ–°æ—¥å¿—ï¼ˆæ˜¾ç¤ºæ‰€æœ‰æ—¥å¿—ï¼Œä¸é™åˆ¶æ•°é‡ï¼‰
                const logsContainer = document.getElementById('logs-container');
                if (status.logs && status.logs.length > 0) {
                    logsContainer.innerHTML = status.logs.map(log => 
                        `<div class="log-entry">${escapeHtml(log)}</div>`
                    ).join('');
                    logsContainer.scrollTop = logsContainer.scrollHeight;
                }
            } catch (error) {
                console.error('æ›´æ–°çŠ¶æ€å¤±è´¥:', error);
            }
        }

        // åŠ è½½è¿­ä»£ä¿¡æ¯
        async function loadIterations() {
            try {
                const response = await fetch(`/api/tasks/${TASK_ID}`);
                const data = await response.json();
                
                if (data.stats) {
                    currentIteration = data.stats.latest_iteration || 0;
                    document.getElementById('current-iteration').textContent = currentIteration;
                } else {
                    console.error('æœªæ‰¾åˆ°ä»»åŠ¡ç»Ÿè®¡ä¿¡æ¯');
                }
            } catch (error) {
                console.error('åŠ è½½è¿­ä»£ä¿¡æ¯å¤±è´¥:', error);
            }
        }

        // å¼€å§‹å½•åˆ¶å’Œè®­ç»ƒ
        async function startRecordAndTrain() {
            const confirmed = await showConfirm(
                'ğŸ“¹ å½•åˆ¶ä¸“å®¶æ¼”ç¤º',
                'ç¡®å®šè¦å¼€å§‹å½•åˆ¶å—ï¼Ÿ\nè¿™å°†æ‰“å¼€æ¸¸æˆçª—å£è¿›è¡Œæ‰‹åŠ¨å½•åˆ¶ã€‚'
            );
            if (!confirmed) {
                return;
            }

            try {
                const response = await fetch('/api/record_and_train', {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    await showAlert('âœ… ä»»åŠ¡å·²å¯åŠ¨', 'è¯·åœ¨æ‰“å¼€çš„æ¸¸æˆçª—å£ä¸­å½•åˆ¶æ¼”ç¤ºã€‚');
                } else {
                    await showAlert('âŒ å¯åŠ¨å¤±è´¥', data.error);
                }
            } catch (error) {
                await showAlert('âŒ è¯·æ±‚å¤±è´¥', error.message);
            }
        }

        // å¼€å§‹DAggerè¿­ä»£
        async function startDaggerIteration() {
            // æ£€æŸ¥æ˜¯å¦å·²æœ‰è¿­ä»£æ¨¡å‹
            const hasIterations = currentIteration > 0;
            
            let mode = 'continue';  // é»˜è®¤ç»§ç»­è¿­ä»£
            
            let cleanData = false;  // æ˜¯å¦æ¸…ç†å†å²æ•°æ®
            
            if (hasIterations) {
                // å¦‚æœå·²æœ‰è¿­ä»£ï¼Œå¼¹æ¡†é€‰æ‹©ç»§ç»­æˆ–æ¸…ç†é‡å¯
                mode = await showDialog(
                    'ğŸ”„ DAgger è¿­ä»£è®­ç»ƒ',
                    `å½“å‰å·²å®Œæˆ ${currentIteration} è½®è¿­ä»£\næœ€æ–°æ¨¡å‹: dagger_iter_${currentIteration}.zip`,
                    {
                        type: 'choice',
                        choices: [
                            {
                                title: 'ğŸ”„ ç»§ç»­è¿­ä»£',
                                description: `ä½¿ç”¨æœ€æ–°çš„ DAgger æ¨¡å‹ç»§ç»­è®­ç»ƒç¬¬ ${currentIteration + 1} è½®`,
                                value: 'continue'
                            },
                            {
                                title: 'ğŸ—‘ï¸ æ¸…ç†é‡å¯',
                                description: 'åˆ é™¤æ‰€æœ‰DAggeræ•°æ®ï¼Œä»BCåŸºçº¿é‡æ–°å¼€å§‹ç¬¬1è½®ï¼ˆä¿ç•™ä¸“å®¶æ¼”ç¤ºå’ŒBCåŸºçº¿ï¼‰',
                                value: 'clean_restart'
                            }
                        ],
                        buttons: [
                            { text: 'å–æ¶ˆ', type: 'cancel', value: null },
                            { text: 'å¼€å§‹è®­ç»ƒ', type: 'primary', value: 'confirm' }
                        ]
                    }
                );
                
                if (!mode) {
                    return;  // ç”¨æˆ·å–æ¶ˆ
                }
                
                // å¤„ç†æ¸…ç†æ¨¡å¼
                if (mode === 'clean_restart') {
                    cleanData = true;
                    mode = 'restart';
                }
            } else {
                // æ²¡æœ‰è¿­ä»£ï¼Œä»å¤´å¼€å§‹
                const confirmed = await showConfirm(
                    'ğŸ”„ DAgger è¿­ä»£è®­ç»ƒ',
                    'å¼€å§‹ç¬¬ä¸€è½®DAggerè¿­ä»£è®­ç»ƒ\n\nå°†æ‰§è¡Œï¼šæ”¶é›†å¤±è´¥çŠ¶æ€ â†’ æ ‡æ³¨ â†’ è®­ç»ƒ â†’ è¿­ä»£'
                );
                if (!confirmed) {
                    return;
                }
            }

            try {
                const response = await fetch('/api/dagger_iteration', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        mode: mode,
                        clean_data: cleanData
                    })
                });
                const data = await response.json();
                
                if (data.success) {
                    await showAlert('âœ… DAggerè¿­ä»£å·²å¯åŠ¨', 'è¯·æŸ¥çœ‹æ—¥å¿—è¾“å‡ºã€‚\nç¨åä¼šè‡ªåŠ¨æ‰“å¼€æ ‡æ³¨å·¥å…·ã€‚');
                    await loadIterations();  // é‡æ–°åŠ è½½è¿­ä»£ä¿¡æ¯
                } else {
                    await showAlert('âŒ å¯åŠ¨å¤±è´¥', data.error);
                }
            } catch (error) {
                await showAlert('âŒ è¯·æ±‚å¤±è´¥', error.message);
            }
        }


        // å·¥å…·å‡½æ•°
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', init);
    </script>
</body>
</html>


<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>训练控制台</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Pro Display', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .subtitle {
            color: #666;
            font-size: 1.1em;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .card h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 1.8em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .icon {
            font-size: 1.2em;
        }

        .card-content {
            margin-top: 20px;
        }

        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 8px;
            font-size: 1.1em;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin-top: 15px;
            font-weight: 600;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .status-panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .status-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1em;
        }

        .indicator-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #10b981;
            animation: pulse 2s infinite;
        }

        .indicator-dot.running {
            background: #f59e0b;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e5e7eb;
            border-radius: 15px;
            overflow: hidden;
            margin: 20px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .logs-container {
            background: #1f2937;
            color: #10b981;
            border-radius: 8px;
            padding: 20px;
            max-height: 500px;
            min-height: 300px;
            overflow-y: auto;
            font-family: 'Monaco', 'Courier New', monospace;
            font-size: 0.9em;
            line-height: 1.6;
        }

        .log-entry {
            margin: 4px 0;
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin: 20px 0;
        }

        .info-item {
            background: #f3f4f6;
            padding: 15px;
            border-radius: 8px;
        }

        .info-label {
            color: #6b7280;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .info-value {
            color: #111827;
            font-size: 1.2em;
            font-weight: 600;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 16px;
            padding: 40px;
            max-width: 900px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        /* 自定义对话框 */
        .custom-dialog {
            max-width: 520px;
            padding: 0;
            overflow: hidden;
        }

        .dialog-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 24px;
            font-size: 1.2em;
            font-weight: 600;
        }

        .dialog-body {
            padding: 24px;
        }

        .dialog-message {
            font-size: 1em;
            color: #374151;
            margin-bottom: 20px;
            line-height: 1.6;
        }

        .dialog-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1em;
            box-sizing: border-box;
            margin-bottom: 20px;
            transition: border-color 0.3s;
        }

        .dialog-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .dialog-buttons {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
        }

        .dialog-btn {
            padding: 10px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
        }

        .dialog-btn-cancel {
            background: #f3f4f6;
            color: #6b7280;
        }

        .dialog-btn-cancel:hover {
            background: #e5e7eb;
        }

        .dialog-btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .dialog-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .dialog-btn-secondary {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .dialog-btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.4);
        }

        .dialog-options {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
        }

        .dialog-option {
            padding: 16px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
        }

        .dialog-option:hover {
            border-color: #667eea;
            background: #f9fafb;
        }

        .dialog-option.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.1) 0%, rgba(118, 75, 162, 0.1) 100%);
        }

        .dialog-option-title {
            font-weight: 600;
            color: #374151;
            margin-bottom: 4px;
        }

        .dialog-option-desc {
            font-size: 0.9em;
            color: #6b7280;
        }

        .close-btn {
            float: right;
            font-size: 2em;
            cursor: pointer;
            color: #6b7280;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: 500;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
        }

        .alert-error {
            background: #fee2e2;
            color: #991b1b;
        }

        .alert-warning {
            background: #fef3c7;
            color: #92400e;
        }

        .directory-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .directory-section {
            background: #f9fafb;
            border-radius: 8px;
            padding: 15px;
        }

        .directory-section h3 {
            color: #374151;
            font-size: 1.1em;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .directory-path {
            font-family: 'Monaco', monospace;
            font-size: 0.85em;
            color: #6b7280;
            margin-bottom: 10px;
        }

        .file-list {
            list-style: none;
            padding: 0;
        }

        .file-item {
            padding: 8px 0;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-item:last-child {
            border-bottom: none;
        }

        .file-name {
            font-family: 'Monaco', monospace;
            font-size: 0.9em;
            color: #111827;
        }

        .file-meta {
            font-size: 0.85em;
            color: #6b7280;
        }

        .eval-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.8em;
            font-weight: 600;
            margin-left: 8px;
        }

        .eval-badge-success {
            background: #d1fae5;
            color: #065f46;
        }

        .eval-badge-info {
            background: #dbeafe;
            color: #1e40af;
        }

        .btn-eval {
            padding: 4px 12px;
            font-size: 0.85em;
            margin-left: 8px;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
        }

        /* Configuration Display Styles */
        .config-categories {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
        }

        .config-category {
            background: #f9fafb;
            border-radius: 12px;
            padding: 16px;
            border: 2px solid #e5e7eb;
        }

        .config-category-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
            font-weight: 600;
            color: #111827;
            font-size: 1.05em;
        }

        .config-category-icon {
            font-size: 1.2em;
        }

        .config-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #e5e7eb;
        }

        .config-item:last-child {
            border-bottom: none;
        }

        .config-label {
            color: #6b7280;
            font-size: 0.9em;
        }

        .config-value {
            color: #111827;
            font-weight: 500;
        }

        /* Configuration Edit Mode */
        .config-edit-form {
            display: none;
        }

        .config-edit-form.active {
            display: block;
        }

        .config-form-group {
            margin-bottom: 12px;
        }

        .config-form-label {
            display: block;
            color: #374151;
            font-weight: 500;
            margin-bottom: 4px;
            font-size: 0.9em;
        }

        .config-form-input {
            width: 100%;
            padding: 8px;
            border: 2px solid #e5e7eb;
            border-radius: 6px;
            font-size: 0.9em;
        }

        .config-form-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .config-form-checkbox {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .config-form-checkbox input {
            width: 16px;
            height: 16px;
        }

        .config-form-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h1>训练控制台</h1>
                    <p class="subtitle">任务: <strong>{{ task_id }}</strong></p>
                </div>
                <button class="btn" onclick="window.location.href='/'" style="background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%);">
                    ← 返回任务列表
                </button>
            </div>
        </header>

        <!-- Directory Info & Evaluation -->
        <div class="card" style="grid-column: 1 / -1; margin-bottom: 20px;">
            <h2><span class="icon">📁</span> 任务数据</h2>
            <div id="directory-info" style="margin-top: 20px;">
                加载中...
            </div>
        </div>

        <!-- Task Configuration -->
        <div class="card" style="grid-column: 1 / -1; margin-bottom: 40px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2><span class="icon">⚙️</span> 任务配置</h2>
                <button class="btn btn-secondary" id="edit-config-btn" onclick="toggleConfigEdit()">
                    📝 编辑配置
                </button>
            </div>
            <div id="config-display">
                加载中...
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- 功能1：录制和训练基线 -->
            <div class="card">
                <h2><span class="icon">📹</span> 录制专家演示</h2>
                <p style="color: #666; margin-bottom: 20px;">
                    步骤：录制演示 → 训练BC基线 → 评估效果
                </p>
                
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">录制Episodes</div>
                        <div class="info-value" id="expert-episodes">10</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">训练Epochs</div>
                        <div class="info-value" id="bc-epochs">50</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">设备</div>
                        <div class="info-value" id="device">MPS</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">最大步数</div>
                        <div class="info-value" id="max-steps">1000</div>
                    </div>
                </div>

                <button class="btn" id="btn-record-train" onclick="startRecordAndTrain()">
                    🚀 开始录制并训练
                </button>
            </div>

            <!-- 功能2：DAgger迭代 -->
            <div class="card">
                <h2><span class="icon">🔄</span> DAgger 迭代训练</h2>
                <p style="color: #666; margin-bottom: 20px;">
                    循环：收集失败 → 标注 → 训练 → 评估
                </p>
                
                <div class="info-grid">
                    <div class="info-item">
                        <div class="info-label">当前迭代</div>
                        <div class="info-value" id="current-iteration">0</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">收集Episodes</div>
                        <div class="info-value" id="collect-episodes">20</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">训练Epochs</div>
                        <div class="info-value" id="dagger-epochs">30</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">评估Episodes</div>
                        <div class="info-value" id="eval-episodes">20</div>
                    </div>
                </div>

                <button class="btn btn-secondary" id="btn-dagger-iter" onclick="startDaggerIteration()">
                    ⚡ 开始DAgger迭代
                </button>
            </div>
        </div>

        <!-- Status Panel -->
        <div class="status-panel">
            <div class="status-header">
                <h2>📊 运行状态</h2>
                <div class="status-indicator">
                    <div class="indicator-dot" id="status-dot"></div>
                    <span id="status-text">就绪</span>
                </div>
            </div>

            <div class="progress-bar">
                <div class="progress-fill" id="progress-fill" style="width: 0%;">0%</div>
            </div>

            <div id="current-stage" style="margin: 15px 0; font-size: 1.1em; color: #374151;"></div>

            <!-- 停止按钮 -->
            <button id="stop-btn" class="btn" style="display: none; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); margin-bottom: 15px; width: 100%;" onclick="stopTask()">
                ⏹️ 停止任务
            </button>

            <div class="logs-container" id="logs-container">
                <div class="log-entry">等待任务开始...</div>
            </div>
        </div>
    </div>

    <!-- 通用对话框 -->
    <div class="modal" id="custom-dialog">
        <div class="modal-content custom-dialog">
            <div class="dialog-header" id="dialog-header"></div>
            <div class="dialog-body">
                <div class="dialog-message" id="dialog-message"></div>
                <div id="dialog-content"></div>
                <div class="dialog-buttons" id="dialog-buttons"></div>
            </div>
        </div>
    </div>

    <script>
        // 任务配置
        const TASK_ID = '{{ task_id }}';
        const CONFIG = {{ config | tojson }};
        
        // 全局状态
        let currentIteration = 0;
        
        // 设置当前任务
        async function setCurrentTask() {
            try {
                await fetch('/api/current_task', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({task_id: TASK_ID})
                });
            } catch (error) {
                console.error('设置当前任务失败:', error);
            }
        }

        // 初始化
        async function init() {
            await setCurrentTask();
            await loadDirectoryInfo();
            await updateStatus();
            await loadIterations();
            loadConfig();
            setInterval(updateStatus, 2000);
            setInterval(loadDirectoryInfo, 10000);  // 每10秒刷新目录信息
        }
        
        // 加载配置到界面
        function loadConfig() {
            document.getElementById('expert-episodes').textContent = CONFIG.expert_episodes || CONFIG.num_expert_episodes || 10;
            document.getElementById('bc-epochs').textContent = CONFIG.bc_epochs || 50;
            document.getElementById('device').textContent = (CONFIG.device || 'MPS').toUpperCase();
            document.getElementById('max-steps').textContent = CONFIG.max_steps || 1000;
            document.getElementById('collect-episodes').textContent = CONFIG.collect_episodes || 20;
            document.getElementById('dagger-epochs').textContent = CONFIG.dagger_epochs || 30;
            document.getElementById('eval-episodes').textContent = CONFIG.eval_episodes || 20;
            
            // 加载完整配置显示
            renderConfigDisplay();
        }

        // 渲染配置显示
        async function renderConfigDisplay() {
            const container = document.getElementById('config-display');
            
            try {
                const response = await fetch('/api/config_template');
                const template = await response.json();
                
                let html = '<div class="config-categories">';
                
                template.categories.forEach(category => {
                    html += `
                        <div class="config-category">
                            <div class="config-category-header">
                                <span class="config-category-icon">${category.icon}</span>
                                <span>${category.name}</span>
                            </div>
                            <div>
                    `;
                    
                    category.fields.forEach(fieldId => {
                        const field = template.fields[fieldId];
                        if (!field) return;
                        
                        let value = CONFIG[fieldId];
                        if (value === undefined || value === null) {
                            value = template.default_config[fieldId];
                        }
                        
                        // 格式化显示值
                        let displayValue = value;
                        if (typeof value === 'boolean') {
                            displayValue = value ? '✓ 是' : '✗ 否';
                        } else if (fieldId === 'device') {
                            displayValue = String(value).toUpperCase();
                        }
                        
                        html += `
                            <div class="config-item">
                                <span class="config-label">${field.label}</span>
                                <span class="config-value">${displayValue}</span>
                            </div>
                        `;
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                
                // 添加编辑表单（隐藏）
                html += '<div class="config-edit-form" id="config-edit-form">';
                html += '<div class="config-categories">';
                
                template.categories.forEach(category => {
                    html += `
                        <div class="config-category">
                            <div class="config-category-header">
                                <span class="config-category-icon">${category.icon}</span>
                                <span>${category.name}</span>
                            </div>
                            <div>
                    `;
                    
                    category.fields.forEach(fieldId => {
                        const field = template.fields[fieldId];
                        if (!field) return;
                        
                        let value = CONFIG[fieldId];
                        if (value === undefined || value === null) {
                            value = template.default_config[fieldId];
                        }
                        
                        html += `<div class="config-form-group">`;
                        
                        if (field.type === 'checkbox') {
                            html += `
                                <div class="config-form-checkbox">
                                    <input type="checkbox" id="edit-${fieldId}" ${value ? 'checked' : ''}>
                                    <label for="edit-${fieldId}" class="config-form-label">${field.label}</label>
                                </div>
                            `;
                        } else {
                            html += `<label class="config-form-label">${field.label}</label>`;
                            
                            if (field.type === 'select') {
                                html += `<select class="config-form-input" id="edit-${fieldId}">`;
                                field.options.forEach(opt => {
                                    html += `<option value="${opt}" ${opt === value ? 'selected' : ''}>${opt}</option>`;
                                });
                                html += `</select>`;
                            } else if (field.type === 'number') {
                                const min = field.min !== undefined ? `min="${field.min}"` : '';
                                const max = field.max !== undefined ? `max="${field.max}"` : '';
                                const step = field.step !== undefined ? `step="${field.step}"` : '';
                                html += `<input type="number" class="config-form-input" id="edit-${fieldId}" 
                                              value="${value}" ${min} ${max} ${step}>`;
                            } else {
                                html += `<input type="text" class="config-form-input" id="edit-${fieldId}" value="${value}">`;
                            }
                        }
                        
                        html += `</div>`;
                    });
                    
                    html += `
                            </div>
                        </div>
                    `;
                });
                
                html += '</div>';
                html += `
                    <div class="config-form-actions">
                        <button class="btn" onclick="saveConfig()" style="flex: 1;">💾 保存配置</button>
                        <button class="btn btn-secondary" onclick="cancelConfigEdit()" style="flex: 1;">❌ 取消</button>
                    </div>
                `;
                html += '</div>';
                
                container.innerHTML = html;
                
            } catch (error) {
                console.error('渲染配置失败:', error);
                container.innerHTML = '<div class="alert alert-error">加载配置失败</div>';
            }
        }

        // 切换配置编辑模式
        function toggleConfigEdit() {
            const displayDiv = document.querySelector('#config-display > .config-categories');
            const editForm = document.getElementById('config-edit-form');
            const btn = document.getElementById('edit-config-btn');
            
            if (editForm.classList.contains('active')) {
                // 取消编辑
                cancelConfigEdit();
            } else {
                // 进入编辑模式
                displayDiv.style.display = 'none';
                editForm.classList.add('active');
                btn.textContent = '❌ 取消编辑';
            }
        }

        // 取消配置编辑
        function cancelConfigEdit() {
            const displayDiv = document.querySelector('#config-display > .config-categories');
            const editForm = document.getElementById('config-edit-form');
            const btn = document.getElementById('edit-config-btn');
            
            displayDiv.style.display = 'grid';
            editForm.classList.remove('active');
            btn.textContent = '📝 编辑配置';
        }

        // 保存配置
        async function saveConfig() {
            try {
                // 收集所有编辑的字段
                const response = await fetch('/api/config_template');
                const template = await response.json();
                
                const updatedConfig = {};
                
                template.categories.forEach(category => {
                    category.fields.forEach(fieldId => {
                        const field = template.fields[fieldId];
                        if (!field) return;
                        
                        const input = document.getElementById(`edit-${fieldId}`);
                        if (!input) return;
                        
                        if (field.type === 'checkbox') {
                            updatedConfig[fieldId] = input.checked;
                        } else if (field.type === 'number') {
                            updatedConfig[fieldId] = parseFloat(input.value) || 0;
                        } else {
                            updatedConfig[fieldId] = input.value;
                        }
                    });
                });
                
                // 发送更新请求
                const saveResponse = await fetch(`/api/tasks/${TASK_ID}/config`, {
                    method: 'PUT',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(updatedConfig)
                });
                
                const data = await saveResponse.json();
                
                if (data.success) {
                    await showAlert('✅ 配置已保存', '配置已成功更新！');
                    
                    // 更新全局配置
                    Object.assign(CONFIG, updatedConfig);
                    
                    // 重新渲染显示
                    await renderConfigDisplay();
                    
                    // 更新其他地方显示的配置值
                    loadConfig();
                    
                    // 取消编辑模式
                    cancelConfigEdit();
                } else {
                    await showAlert('❌ 保存失败', data.error);
                }
            } catch (error) {
                await showAlert('❌ 保存失败', error.message);
            }
        }
        
        // 加载目录信息
        async function loadDirectoryInfo() {
            try {
                const response = await fetch(`/api/tasks/${TASK_ID}/directory`);
                const data = await response.json();
                
                if (data.error) {
                    document.getElementById('directory-info').innerHTML = 
                        `<div class="alert alert-error">${data.error}</div>`;
                    return;
                }
                
                let html = '<div class="directory-grid">';
                
                // BC基线模型
                html += '<div class="directory-section">';
                html += '<h3>🎯 BC基线模型</h3>';
                html += `<div class="directory-path">${data.baseline_model.path}</div>`;
                
                if (data.baseline_model.models.length > 0) {
                    html += '<ul class="file-list">';
                    data.baseline_model.models.forEach(model => {
                        html += '<li class="file-item">';
                        html += '<div>';
                        html += `<div class="file-name">${model.name}</div>`;
                        html += `<div class="file-meta">${model.size} | ${model.modified}</div>`;
                        if (model.eval_result) {
                            html += `<span class="eval-badge eval-badge-success">成功率: ${model.eval_result.success_rate}</span>`;
                            html += `<span class="eval-badge eval-badge-info">平均步数: ${model.eval_result.avg_steps}</span>`;
                        }
                        html += '</div>';
                        html += `<button class="btn btn-eval" onclick="evaluateModel('${model.name}')">📊 评估</button>`;
                        html += '</li>';
                    });
                    html += '</ul>';
                } else {
                    html += '<p style="color: #9ca3af;">暂无基线模型</p>';
                }
                html += '</div>';
                
                // DAgger迭代模型
                html += '<div class="directory-section">';
                html += '<h3>🔄 DAgger迭代模型</h3>';
                html += `<div class="directory-path">${data.dagger_model.path}</div>`;
                
                if (data.dagger_model.models.length > 0) {
                    html += '<ul class="file-list">';
                    data.dagger_model.models.forEach(model => {
                        html += '<li class="file-item">';
                        html += '<div>';
                        html += `<div class="file-name">${model.name}</div>`;
                        html += `<div class="file-meta">${model.size} | ${model.modified}</div>`;
                        if (model.eval_result) {
                            html += `<span class="eval-badge eval-badge-success">成功率: ${model.eval_result.success_rate}</span>`;
                            html += `<span class="eval-badge eval-badge-info">平均步数: ${model.eval_result.avg_steps}</span>`;
                        }
                        html += '</div>';
                        html += `<button class="btn btn-eval" onclick="evaluateModel('${model.name}')">📊 评估</button>`;
                        html += '</li>';
                    });
                    html += '</ul>';
                } else {
                    html += '<p style="color: #9ca3af;">暂无迭代模型</p>';
                }
                html += '</div>';
                
                // Expert Demos (简化显示)
                html += '<div class="directory-section">';
                html += '<h3>📹 专家演示</h3>';
                html += `<div class="directory-path">${data.expert_demos.path}</div>`;
                
                const episodeCount = data.expert_demos.episodes.filter(ep => !ep.name.includes('...')).length;
                if (episodeCount > 0) {
                    html += '<div style="padding: 15px; text-align: center;">';
                    html += `<div style="font-size: 2em; color: #10b981; font-weight: bold;">${episodeCount}</div>`;
                    html += '<div style="color: #6b7280; margin-top: 5px;">个 episodes</div>';
                    html += '</div>';
                } else {
                    html += '<p style="color: #9ca3af;">暂无演示</p>';
                }
                html += '</div>';
                
                // Expert Labels
                html += '<div class="directory-section">';
                html += '<h3>🏷️ 专家标注</h3>';
                html += `<div class="directory-path">${data.expert_labels.path}</div>`;
                
                if (data.expert_labels.files.length > 0) {
                    html += '<ul class="file-list">';
                    data.expert_labels.files.forEach(file => {
                        // 提取迭代编号
                        const iterMatch = file.name.match(/iter_(\d+)\.pkl/);
                        const iterNum = iterMatch ? iterMatch[1] : null;
                        
                        html += '<li class="file-item">';
                        html += '<div>';
                        html += `<div class="file-name">${file.name}</div>`;
                        html += `<div class="file-meta">${file.size}</div>`;
                        html += '</div>';
                        
                        if (iterNum) {
                            html += `<button class="btn btn-eval" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);" onclick="relabelIteration(${iterNum})">🔄 重新标注</button>`;
                        }
                        html += '</li>';
                    });
                    html += '</ul>';
                } else {
                    html += '<p style="color: #9ca3af;">暂无标注</p>';
                }
                html += '</div>';
                
                // Policy States
                html += '<div class="directory-section">';
                html += '<h3>📦 策略状态</h3>';
                html += `<div class="directory-path">${data.policy_states.path}</div>`;
                
                if (data.policy_states.iterations.length > 0) {
                    html += '<ul class="file-list">';
                    data.policy_states.iterations.forEach(iter => {
                        html += '<li class="file-item">';
                        html += `<span class="file-name">${iter.name}</span>`;
                        html += `<span class="file-meta">${iter.states} 状态</span>`;
                        html += '</li>';
                    });
                    html += '</ul>';
                } else {
                    html += '<p style="color: #9ca3af;">暂无状态</p>';
                }
                html += '</div>';
                
                // Dagger Data
                html += '<div class="directory-section">';
                html += '<h3>🔄 DAgger数据</h3>';
                html += `<div class="directory-path">${data.dagger.path}</div>`;
                
                if (data.dagger.files.length > 0) {
                    html += '<ul class="file-list">';
                    data.dagger.files.forEach(file => {
                        html += '<li class="file-item">';
                        html += `<span class="file-name">${file.name}</span>`;
                        html += `<span class="file-meta">${file.size}</span>`;
                        html += '</li>';
                    });
                    html += '</ul>';
                } else {
                    html += '<p style="color: #9ca3af;">暂无数据</p>';
                }
                html += '</div>';
                
                html += '</div>';
                
                document.getElementById('directory-info').innerHTML = html;
                
            } catch (error) {
                console.error('加载目录信息失败:', error);
                document.getElementById('directory-info').innerHTML = 
                    `<div class="alert alert-error">加载失败: ${error.message}</div>`;
            }
        }
        
        // ============================================================================
        // 自定义对话框
        // ============================================================================

        function showDialog(title, message, options) {
            return new Promise((resolve) => {
                const dialog = document.getElementById('custom-dialog');
                const header = document.getElementById('dialog-header');
                const msg = document.getElementById('dialog-message');
                const content = document.getElementById('dialog-content');
                const buttons = document.getElementById('dialog-buttons');

                header.textContent = title;
                msg.textContent = message;
                content.innerHTML = '';
                buttons.innerHTML = '';

                if (options.type === 'input') {
                    const input = document.createElement('input');
                    input.className = 'dialog-input';
                    input.type = 'number';
                    input.value = options.defaultValue || '';
                    input.placeholder = options.placeholder || '';
                    content.appendChild(input);

                    input.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            const value = input.value;
                            dialog.classList.remove('active');
                            resolve(value || null);
                        }
                    });

                    setTimeout(() => input.focus(), 100);
                }

                if (options.type === 'choice') {
                    const optionsContainer = document.createElement('div');
                    optionsContainer.className = 'dialog-options';

                    options.choices.forEach((choice, index) => {
                        const optionDiv = document.createElement('div');
                        optionDiv.className = 'dialog-option';
                        if (index === 0) optionDiv.classList.add('selected');

                        optionDiv.innerHTML = `
                            <div class="dialog-option-title">${choice.title}</div>
                            <div class="dialog-option-desc">${choice.description}</div>
                        `;

                        optionDiv.addEventListener('click', () => {
                            document.querySelectorAll('.dialog-option').forEach(o => o.classList.remove('selected'));
                            optionDiv.classList.add('selected');
                        });

                        optionsContainer.appendChild(optionDiv);
                    });

                    content.appendChild(optionsContainer);
                }

                // 添加按钮
                if (options.buttons) {
                    options.buttons.forEach(btn => {
                        const button = document.createElement('button');
                        button.className = `dialog-btn dialog-btn-${btn.type || 'primary'}`;
                        button.textContent = btn.text;
                        button.addEventListener('click', () => {
                            dialog.classList.remove('active');

                            if (options.type === 'input') {
                                const input = content.querySelector('input');
                                resolve(btn.value === 'confirm' ? input.value : null);
                            } else if (options.type === 'choice') {
                                const selected = content.querySelector('.dialog-option.selected');
                                const selectedIndex = Array.from(selected.parentNode.children).indexOf(selected);
                                resolve(btn.value === 'confirm' ? options.choices[selectedIndex].value : null);
                            } else {
                                resolve(btn.value);
                            }
                        });
                        buttons.appendChild(button);
                    });
                }

                dialog.classList.add('active');

                // 点击背景关闭
                dialog.addEventListener('click', (e) => {
                    if (e.target === dialog) {
                        dialog.classList.remove('active');
                        resolve(null);
                    }
                });
            });
        }

        function showAlert(title, message) {
            return showDialog(title, message, {
                buttons: [
                    { text: '确定', type: 'primary', value: true }
                ]
            });
        }

        function showConfirm(title, message) {
            return showDialog(title, message, {
                buttons: [
                    { text: '取消', type: 'cancel', value: false },
                    { text: '确定', type: 'primary', value: true }
                ]
            });
        }

        // ============================================================================
        // 页面功能
        // ============================================================================

        // 重新标注迭代
        async function relabelIteration(iterNum) {
            const confirmed = await showConfirm(
                '🔄 重新标注迭代',
                `确定要删除迭代 ${iterNum} 的专家标注数据吗？\n\n删除后可以使用 label_states.py 重新标注该迭代的状态。`
            );
            
            if (!confirmed) {
                return;
            }
            
            try {
                const response = await fetch(`/api/tasks/${TASK_ID}/relabel_iteration`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        iteration: iterNum
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    await showAlert('✅ 标注已清除', data.message);
                    await loadDirectoryInfo();  // 刷新目录信息
                } else {
                    await showAlert('❌ 清除失败', data.error);
                }
            } catch (error) {
                await showAlert('❌ 请求失败', error.message);
            }
        }
        
        // 评估模型
        async function evaluateModel(modelName) {
            // 弹出对话框设置评估次数
            const episodes = await showDialog(
                '📊 评估模型',
                `模型: ${modelName}`,
                {
                    type: 'input',
                    defaultValue: CONFIG.eval_episodes || 20,
                    placeholder: '请输入评估次数（Episodes）',
                    buttons: [
                        { text: '取消', type: 'cancel', value: null },
                        { text: '开始评估', type: 'primary', value: 'confirm' }
                    ]
                }
            );
            
            if (!episodes) {
                return;  // 用户取消
            }
            
            const episodesNum = parseInt(episodes);
            if (isNaN(episodesNum) || episodesNum <= 0) {
                await showAlert('❌ 输入错误', '请输入有效的正整数！');
                return;
            }
            
            try {
                const response = await fetch(`/api/tasks/${TASK_ID}/evaluate`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({
                        model_name: modelName,
                        episodes: episodesNum
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    await showAlert('✅ 评估已启动', `模型: ${modelName}\nEpisodes: ${episodesNum}\n\n请查看日志输出。`);
                } else {
                    await showAlert('❌ 启动失败', data.error);
                }
            } catch (error) {
                await showAlert('❌ 请求失败', error.message);
            }
        }
        
        // 停止当前任务
        async function stopTask() {
            const confirmed = await showConfirm('⏹️ 停止任务', '确定要停止当前运行的任务吗？');
            if (!confirmed) {
                return;
            }
            
            try {
                const response = await fetch('/api/stop', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });
                
                const data = await response.json();
                
                if (data.success) {
                    await showAlert('✅ 任务已停止', '任务已成功终止。');
                } else {
                    await showAlert('❌ 停止失败', data.error || '未知错误');
                }
            } catch (error) {
                await showAlert('❌ 请求失败', error.message);
            }
        }

        // 更新状态
        async function updateStatus() {
            try {
                const response = await fetch('/api/status');
                const status = await response.json();

                // 更新状态指示器
                const dot = document.getElementById('status-dot');
                const text = document.getElementById('status-text');
                const stopBtn = document.getElementById('stop-btn');
                
                if (status.running) {
                    dot.classList.add('running');
                    text.textContent = '运行中';
                    document.getElementById('btn-record-train').disabled = true;
                    document.getElementById('btn-dagger-iter').disabled = true;
                    stopBtn.style.display = 'block';  // 显示停止按钮
                } else {
                    dot.classList.remove('running');
                    text.textContent = '就绪';
                    document.getElementById('btn-record-train').disabled = false;
                    document.getElementById('btn-dagger-iter').disabled = false;
                    stopBtn.style.display = 'none';   // 隐藏停止按钮
                }

                // 更新进度
                const progress = status.progress || 0;
                const fill = document.getElementById('progress-fill');
                fill.style.width = progress + '%';
                fill.textContent = progress + '%';

                // 更新阶段
                const stageMap = {
                    'recording': '📹 录制专家演示',
                    'training_bc': '🎓 训练BC基线',
                    'evaluating': '📊 评估策略',
                    'collecting': '📦 收集失败状态',
                    'labeling': '🏷️ 等待标注',
                    'training': '🚀 训练模型',
                    'completed': '✅ 完成'
                };
                
                document.getElementById('current-stage').textContent = 
                    stageMap[status.stage] || status.message;

                // 更新日志（显示所有日志，不限制数量）
                const logsContainer = document.getElementById('logs-container');
                if (status.logs && status.logs.length > 0) {
                    logsContainer.innerHTML = status.logs.map(log => 
                        `<div class="log-entry">${escapeHtml(log)}</div>`
                    ).join('');
                    logsContainer.scrollTop = logsContainer.scrollHeight;
                }
            } catch (error) {
                console.error('更新状态失败:', error);
            }
        }

        // 加载迭代信息
        async function loadIterations() {
            try {
                const response = await fetch(`/api/tasks/${TASK_ID}`);
                const data = await response.json();
                
                if (data.stats) {
                    currentIteration = data.stats.latest_iteration || 0;
                    document.getElementById('current-iteration').textContent = currentIteration;
                } else {
                    console.error('未找到任务统计信息');
                }
            } catch (error) {
                console.error('加载迭代信息失败:', error);
            }
        }

        // 开始录制和训练
        async function startRecordAndTrain() {
            const confirmed = await showConfirm(
                '📹 录制专家演示',
                '确定要开始录制吗？\n这将打开游戏窗口进行手动录制。'
            );
            if (!confirmed) {
                return;
            }

            try {
                const response = await fetch('/api/record_and_train', {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.success) {
                    await showAlert('✅ 任务已启动', '请在打开的游戏窗口中录制演示。');
                } else {
                    await showAlert('❌ 启动失败', data.error);
                }
            } catch (error) {
                await showAlert('❌ 请求失败', error.message);
            }
        }

        // 开始DAgger迭代
        async function startDaggerIteration() {
            // 检查是否已有迭代模型
            const hasIterations = currentIteration > 0;
            
            let mode = 'continue';  // 默认继续迭代
            
            let cleanData = false;  // 是否清理历史数据
            
            if (hasIterations) {
                // 如果已有迭代，弹框选择继续或清理重启
                mode = await showDialog(
                    '🔄 DAgger 迭代训练',
                    `当前已完成 ${currentIteration} 轮迭代\n最新模型: dagger_iter_${currentIteration}.zip`,
                    {
                        type: 'choice',
                        choices: [
                            {
                                title: '🔄 继续迭代',
                                description: `使用最新的 DAgger 模型继续训练第 ${currentIteration + 1} 轮`,
                                value: 'continue'
                            },
                            {
                                title: '🗑️ 清理重启',
                                description: '删除所有DAgger数据，从BC基线重新开始第1轮（保留专家演示和BC基线）',
                                value: 'clean_restart'
                            }
                        ],
                        buttons: [
                            { text: '取消', type: 'cancel', value: null },
                            { text: '开始训练', type: 'primary', value: 'confirm' }
                        ]
                    }
                );
                
                if (!mode) {
                    return;  // 用户取消
                }
                
                // 处理清理模式
                if (mode === 'clean_restart') {
                    cleanData = true;
                    mode = 'restart';
                }
            } else {
                // 没有迭代，从头开始
                const confirmed = await showConfirm(
                    '🔄 DAgger 迭代训练',
                    '开始第一轮DAgger迭代训练\n\n将执行：收集失败状态 → 标注 → 训练 → 迭代'
                );
                if (!confirmed) {
                    return;
                }
            }

            try {
                const response = await fetch('/api/dagger_iteration', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        mode: mode,
                        clean_data: cleanData
                    })
                });
                const data = await response.json();
                
                if (data.success) {
                    await showAlert('✅ DAgger迭代已启动', '请查看日志输出。\n稍后会自动打开标注工具。');
                    await loadIterations();  // 重新加载迭代信息
                } else {
                    await showAlert('❌ 启动失败', data.error);
                }
            } catch (error) {
                await showAlert('❌ 请求失败', error.message);
            }
        }


        // 工具函数
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // 页面加载时初始化
        window.addEventListener('load', init);
    </script>
</body>
</html>


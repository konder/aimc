# AIMC MineDojo Docker é•œåƒ - è°ƒè¯•ç‰ˆæœ¬
# åªæ„å»ºåˆ° Python ä¾èµ–å®‰è£…ï¼Œä¸åŒ…å« MineCLIP å’Œ MC ç¼–è¯‘
# ç”¨äºè¿›å…¥å®¹å™¨æ‰‹åŠ¨è°ƒè¯•

FROM ubuntu:20.04

# è®¾ç½®éäº¤äº’æ¨¡å¼
ENV DEBIAN_FRONTEND=noninteractive

# [é‡è¦] å¦‚æœåœ¨ä¼ä¸šç½‘ç»œç¯å¢ƒä¸­ï¼Œéœ€è¦é…ç½®ä»£ç†æˆ–ä½¿ç”¨å›½å†…é•œåƒæº
# å–æ¶ˆä¸‹é¢çš„æ³¨é‡Šæ¥ä½¿ç”¨é˜¿é‡Œäº‘é•œåƒæº
RUN sed -i 's|http://archive.ubuntu.com|http://mirrors.aliyun.com|g' /etc/apt/sources.list && \
    sed -i 's|http://security.ubuntu.com|http://mirrors.aliyun.com|g' /etc/apt/sources.list

# æ›´æ–°ç³»ç»Ÿå¹¶å®‰è£…åŸºç¡€ä¾èµ–
RUN apt-get update && \
    apt-get install -y \
    openjdk-8-jdk \
    wget \
    curl \
    git \
    build-essential \
    ca-certificates \
    libgl1-mesa-glx \
    libglib2.0-0 \
    libsm6 \
    libxext6 \
    libxrender-dev \
    libgomp1 \
    && rm -rf /var/lib/apt/lists/*

# å®‰è£… Miniconda
RUN wget --no-check-certificate https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O /tmp/miniconda.sh && \
    bash /tmp/miniconda.sh -b -p /opt/conda && \
    rm /tmp/miniconda.sh

# é…ç½®ç¯å¢ƒå˜é‡
ENV PATH="/opt/conda/bin:${PATH}"
ENV JAVA_HOME=/usr/lib/jvm/java-8-openjdk-amd64
ENV MINEDOJO_HEADLESS=1

# é…ç½® conda å’Œ pip ä½¿ç”¨å›½å†…é•œåƒæºï¼ˆå¯é€‰ï¼‰
RUN conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/main/ && \
    conda config --add channels https://mirrors.tuna.tsinghua.edu.cn/anaconda/pkgs/free/ && \
    conda config --set show_channel_urls yes

# æ¥å— Conda æœåŠ¡æ¡æ¬¾å¹¶åˆ›å»º minedojo-x86 ç¯å¢ƒ
RUN conda tos accept --override-channels --channel https://repo.anaconda.com/pkgs/main && \
    conda tos accept --override-channels --channel https://repo.anaconda.com/pkgs/r && \
    conda create -n minedojo-x86 python=3.9 -y && \
    conda init bash && \
    echo "conda activate minedojo-x86" >> /root/.bashrc

# å¤åˆ¶é¡¹ç›®æ–‡ä»¶
COPY requirements.txt /tmp/requirements.txt
COPY build_local_cache.zip /root/build_local_cache.zip
RUN unzip /root/build_local_cache.zip -d /root/

# å®‰è£… Python ä¾èµ–
SHELL ["/bin/bash", "-c"]
RUN source /opt/conda/etc/profile.d/conda.sh && \
    conda activate minedojo-x86 && \
    pip install "pip<24.1" "setuptools<58" "wheel<0.38.0" && \
    pip install minedojo && \
    pip install -r /tmp/requirements.txt && \
    rm /tmp/requirements.txt

COPY docker/mc_config.patch /tmp/mc_config.patch

RUN cd /opt/conda/envs/minedojo-x86/lib/python3.9/site-packages/minedojo/sim/Malmo/Minecraft
# ==================== è°ƒè¯•ç‰ˆæœ¬åˆ°æ­¤ç»“æŸ ====================
# ä»¥ä¸‹æ­¥éª¤å¯ä»¥åœ¨å®¹å™¨å†…æ‰‹åŠ¨æ‰§è¡Œæµ‹è¯•

# è®¾ç½®å·¥ä½œç›®å½•
WORKDIR /workspace

# æ‰“å°æç¤ºä¿¡æ¯
RUN echo '========================================' && \
    echo 'ğŸ› AIMC è°ƒè¯•é•œåƒæ„å»ºå®Œæˆ' && \
    echo '========================================' && \
    echo '' && \
    echo 'âœ… å·²å®Œæˆçš„æ­¥éª¤:' && \
    echo '  - Ubuntu 20.04 åŸºç¡€ç¯å¢ƒ' && \
    echo '  - OpenJDK 8' && \
    echo '  - Miniconda + Python 3.9' && \
    echo '  - MineDojo åŠä¾èµ–åŒ…' && \
    echo '' && \
    echo 'â³ å¾…æ‰‹åŠ¨æ‰§è¡Œçš„æ­¥éª¤:' && \
    echo '  1. MineCLIP å®‰è£…: bash /root/install_mineclip.sh' && \
    echo '  2. MixinGradle: cd /opt/hotfix && git clone https://github.com/verityw/MixinGradle-dcfaf61.git' && \
    echo '  3. MC ç¼–è¯‘è¯Šæ–­: bash /root/fix_mixingradle.sh' && \
    echo '  4. MC ç¼–è¯‘éªŒè¯: bash /root/verify_mc_build.sh' && \
    echo '' && \
    echo 'ğŸ“ MineDojo è·¯å¾„:' && \
    echo '  /opt/conda/envs/minedojo-x86/lib/python3.9/site-packages/minedojo/sim/Malmo/Minecraft' && \
    echo '' && \
    echo '========================================' && \
    echo ''

# é»˜è®¤æ¿€æ´» minedojo-x86 ç¯å¢ƒ
ENTRYPOINT ["/bin/bash", "-c", "source /opt/conda/etc/profile.d/conda.sh && conda activate minedojo-x86 && exec /bin/bash"]


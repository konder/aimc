# Prior评估可视化增强总结

> **日期**: 2025-11-27  
> **目标**: 为Prior模型评估添加专业的可视化分析

---

## 🎨 新增可视化功能

### 1. **📍 t-SNE 嵌入空间图**
**目的**: 直观展示Prior输出与真实成功画面在低维空间的分布

**内容**:
- 🔵 **蓝点**: Prior输出 (z_goal)
- 🔴 **红点**: 真实成功画面嵌入 (z_visual_mean)
- **理想情况**: 蓝点和红点重叠度高，说明Prior准确"想象"出目标画面

**技术细节**:
- 使用sklearn的TSNE进行降维
- 2D可视化，perplexity自适应调整
- 交互式悬停显示任务ID和坐标

---

### 2. **📊 PCA 嵌入空间图**
**目的**: 主成分分析，展示嵌入空间的主要变化方向

**内容**:
- 🔵 **蓝点**: Prior输出
- 🔴 **红点**: 真实成功画面
- **坐标轴**: PC1和PC2，显示方差解释比例

**优势**:
- 比t-SNE更稳定（线性变换）
- 能看到主要差异方向
- 方差解释比例帮助理解数据结构

---

### 3. **🔥 Prior输出相似度矩阵**
**目的**: 展示不同任务之间Prior输出的相似度

**解读**:
- **对角线**: 应该是深绿色（自己vs自己=1.0）
- **非对角线**: 应该较浅（不同任务应该可区分）
- **全绿**: ⚠️ 警告！可能退化（所有任务输出相似）

**用途**:
- 直观评估可区分性
- 快速识别过于相似的任务对

---

### 4. **📈 目标准确性 vs 一致性散点图**
**目的**: 同时评估两个关键指标的关系

**颜色编码**:
- 🟢 **绿点**: 优秀（准确性≥0.6, 一致性≥0.95）
- 🟡 **黄点**: 良好（准确性≥0.4, 一致性≥0.85）
- 🔴 **红点**: 需改进

**理想分布**: 点集中在右上角（高准确性+高一致性）

---

### 5. **📉 Prior输出方差分布**
**目的**: 检测Prior是否退化

**内容**:
- 直方图展示各维度方差分布
- 红色区域: 方差 < 0.0001（退化警告）
- 蓝色区域: 正常方差

**警告标志**:
- 如果大量维度方差过低 → Prior可能退化为常数输出
- 平均方差显示在x轴标题

---

### 6. **🏆 Top-5/Bottom-5 任务排行**
**目的**: 快速识别最好和最差的任务

**Top-5 最佳任务**:
- 绿色背景
- 显示任务ID、指令、准确性、一致性

**Bottom-5 待改进任务**:
- 红色背景
- 帮助定位问题任务

---

## 📊 完整HTML报告结构

```
┌────────────────────────────────────────┐
│ 🎯 Prior模型评估报告                   │
├────────────────────────────────────────┤
│ 1️⃣ 整体评估                            │
│    - 4个核心指标卡片                    │
│    - 可区分性详细说明                   │
│                                        │
│ 2️⃣ 指标说明                            │
│    - 每个指标的定义和评分标准           │
│                                        │
│ 3️⃣ 基础可视化分析（4个柱状图）         │
│    - 目标准确性对比                     │
│    - 一致性对比                        │
│    - 语义鲁棒性对比                     │
│    - 综合指标对比                       │
│                                        │
│ 4️⃣ 高级分析 ✨ NEW                     │
│    - t-SNE嵌入空间                     │
│    - PCA嵌入空间                       │
│    - 相似度矩阵                        │
│    - 准确性vs一致性散点图               │
│    - 方差分布                          │
│    - Top-K/Bottom-K排行                │
│                                        │
│ 5️⃣ 任务详细结果表格                    │
│                                        │
│ 6️⃣ 改进建议                            │
└────────────────────────────────────────┘
```

---

## 🔧 技术实现

### **后端（steve1_prior_evaluator.py）**

新增方法:
```python
def _generate_visualization_data(
    self,
    task_ids: List[str],
    results: List[PriorAnalysisResult],
    all_z_goals: List[np.ndarray]
) -> Dict
```

计算内容:
1. **t-SNE降维**: Prior输出 + 真实画面 → 2D坐标
2. **PCA降维**: 同上，并记录方差解释比例
3. **相似度矩阵**: 计算所有任务对的余弦相似度
4. **方差分布**: 每个维度的方差统计
5. **排行榜**: 按目标准确性排序Top-K/Bottom-K
6. **散点数据**: 准确性vs一致性

### **前端（prior_html_generator.py）**

新增方法:
```python
def _generate_advanced_visualizations(
    self, 
    visualization_data: Dict
) -> str
```

使用Chart.js绘制:
- Scatter charts (散点图): t-SNE, PCA, 准确性vs一致性
- Bubble chart (气泡图): 相似度矩阵
- Bar chart (柱状图): 方差分布
- 自定义HTML: Top-K/Bottom-K排行

---

## 📈 对比：原来 vs 现在

### **原来**
❌ 错误的指标：
- Text-Prior Similarity（跨空间比较，无意义）
- VAE Reconstruction Quality（间接指标）

⚠️ 有限的可视化：
- 只有基础柱状图
- 没有嵌入空间分析
- 没有相似度矩阵

### **现在**
✅ 正确的指标：
- Goal Accuracy（Prior vs 真实画面，同空间）
- Consistency（多次采样稳定性）
- Semantic Robustness（指令变体一致性）
- Discriminability（跨任务可区分性）

✅ 全面的可视化：
- 基础柱状图（4个）
- 嵌入空间分析（t-SNE + PCA）
- 相似度矩阵热力图
- 散点图分析
- 方差分布
- 排行榜

---

## 🚀 使用方法

运行评估后自动生成完整HTML报告：

```bash
bash scripts/run_prior_evaluation.sh \
    --eval-result-dir results/evaluation/all_tasks_20251121_214545 \
    --output-dir results/prior_evaluation/all_tasks_20251121_214545
```

**输出**:
```
results/prior_evaluation/all_tasks_20251121_214545/
├── prior_evaluation_report.html        ← 📊 完整可视化报告
├── prior_evaluation_summary.json       ← 📄 JSON数据
└── success_visuals_*.pkl              ← 💾 缓存数据
```

用浏览器打开HTML报告即可查看所有可视化！

---

## 💡 如何解读报告

### **1. 整体评估卡片**
快速了解模型整体表现

### **2. 基础柱状图**
对比各任务在单个指标上的表现

### **3. 嵌入空间图（t-SNE/PCA）**
**关键问题**: 蓝点（Prior）和红点（真实画面）重叠了吗？
- ✅ **重叠度高**: Prior准确预测目标
- ⚠️ **分离明显**: Prior与真实存在gap

### **4. 相似度矩阵**
**关键问题**: 非对角线是否足够浅？
- ✅ **浅色**: 可区分性好
- ⚠️ **深色**: 不同任务输出过于相似

### **5. 散点图**
**关键问题**: 点是否集中在右上角？
- ✅ **右上角**: 高准确性+高一致性
- ⚠️ **左下角**: 需要改进的任务

### **6. 方差分布**
**关键问题**: 是否有大量红色柱子？
- ✅ **蓝色为主**: Prior输出多样
- ⚠️ **红色过多**: 可能退化

### **7. Top-K/Bottom-K**
**关键问题**: Bottom-5任务有什么共同特征？
- 找出这些任务的规律
- 针对性改进训练数据

---

## 🎓 参考文献

**Prior评估设计思路**:
- 参考: STEVE-1论文
- 核心: Prior应该"想象"出完成任务的画面
- 验证: 与真实成功画面比较（同空间）

**可视化技术**:
- t-SNE: van der Maaten & Hinton, 2008
- PCA: Pearson, 1901
- Chart.js: 开源可视化库

---

## 📝 总结

这次增强使Prior评估报告达到**论文级别的可视化质量**：

✅ **科学性**: 正确的指标定义（同空间比较）  
✅ **全面性**: 从多个角度分析Prior性能  
✅ **直观性**: 丰富的图表帮助快速理解  
✅ **实用性**: 明确指出需要改进的任务  

现在可以像分析论文实验结果一样，深入分析Prior模型的性能！🎉


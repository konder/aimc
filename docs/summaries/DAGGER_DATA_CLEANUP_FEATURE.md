# DAgger æ•°æ®æ¸…ç†åŠŸèƒ½å®ç°æ€»ç»“

**æ—¥æœŸ**: 2025-10-25  
**æ›´æ–°**: 2025-10-25ï¼ˆä¿®æ­£é€»è¾‘ï¼‰  
**åŠŸèƒ½**: ä¸º DAgger è®­ç»ƒæµç¨‹æ·»åŠ å†å²æ•°æ®æ¸…ç†åŠŸèƒ½

## é—®é¢˜èƒŒæ™¯

åœ¨ DAgger è®­ç»ƒè¿‡ç¨‹ä¸­ï¼Œå¦‚æœéœ€è¦"é‡å¤´å¼€å§‹"ï¼Œåº”è¯¥æ¸…ç†ç›¸å…³çš„å†å²æ•°æ®ä»¥é¿å…æ•°æ®æ··ä¹±ã€‚

### é‡è¦åŸåˆ™

âš ï¸ **ä¸“å®¶æ¼”ç¤ºæ•°æ®éå¸¸çè´µï¼ˆéœ€è¦äººå·¥å½•åˆ¶ï¼‰ï¼Œä»»ä½•æƒ…å†µä¸‹éƒ½ä¸åº”è¯¥åˆ é™¤ï¼**

### éœ€è¦æ¸…ç†çš„åœºæ™¯

å½“éœ€è¦ä»BCåŸºçº¿é‡æ–°å¼€å§‹DAggerè®­ç»ƒæ—¶ï¼Œåº”è¯¥åˆ é™¤ï¼š
- `expert_labels/` - ä¸“å®¶æ ‡æ³¨æ•°æ®
- `policy_states/` - ç­–ç•¥æ”¶é›†çš„çŠ¶æ€
- `dagger/` - èšåˆæ•°æ®
- `dagger_model/` - DAggerè¿­ä»£æ¨¡å‹

### æ°¸è¿œä¿ç•™çš„æ•°æ®

âœ… **ä»¥ä¸‹æ•°æ®æ°¸è¿œä¸åˆ é™¤**ï¼š
- `expert_demos/` - ä¸“å®¶æ¼”ç¤ºï¼ˆäººå·¥å½•åˆ¶ï¼Œéå¸¸çè´µï¼‰
- `baseline_model/` - BCåŸºçº¿æ¨¡å‹ï¼ˆåŸºäºä¸“å®¶æ¼”ç¤ºè®­ç»ƒï¼‰

## å®ç°æ–¹æ¡ˆ

### 1. `run_dagger_iteration.sh` ä¿®æ”¹

**æ–°å¢å‚æ•°**:
```bash
--clean-restart    # æ¸…ç†å†å²DAggeræ•°æ®ï¼Œä»BCåŸºçº¿é‡æ–°å¼€å§‹
```

**æ¸…ç†å†…å®¹**:
- `policy_states/` ç›®å½•ä¸‹æ‰€æœ‰å†…å®¹
- `expert_labels/` ç›®å½•ä¸‹æ‰€æœ‰å†…å®¹
- `dagger/` ç›®å½•ä¸‹æ‰€æœ‰å†…å®¹
- `dagger_model/` ç›®å½•ä¸‹æ‰€æœ‰å†…å®¹

**è¡Œä¸º**:
- å¼ºåˆ¶ä» BC åŸºçº¿æ¨¡å‹å¼€å§‹
- é‡ç½®è¿­ä»£ç¼–å·ä¸º 1

**ä½¿ç”¨ç¤ºä¾‹**:
```bash
# æ¸…ç†DAggeræ•°æ®ï¼Œä»BCåŸºçº¿é‡æ–°å¼€å§‹
bash scripts/run_dagger_iteration.sh --task harvest_1_log --clean-restart
```

### 2. `run_dagger_workflow.sh` ä¿®æ”¹

**æ–°å¢å‚æ•°**:
```bash
--clean-restart       # æ¸…ç†DAggeræ•°æ®ï¼Œä»BCåŸºçº¿é‡æ–°å¼€å§‹ï¼ˆä¿ç•™ä¸“å®¶æ¼”ç¤ºå’ŒBCåŸºçº¿ï¼‰
--clean-dagger-only   # åŒ --clean-restartï¼ˆå…¼å®¹æ—§å‚æ•°ï¼‰
```

#### `--clean-restart` å’Œ `--clean-dagger-only` (æ¸…ç†DAggeræ•°æ®)

**æ¸…ç†å†…å®¹**:
- `policy_states/` - ç­–ç•¥çŠ¶æ€
- `expert_labels/` - ä¸“å®¶æ ‡æ³¨
- `dagger/` - èšåˆæ•°æ®
- `dagger_model/` - DAggeræ¨¡å‹

**ä¿ç•™å†…å®¹**:
- `expert_demos/` - ä¸“å®¶æ¼”ç¤ºï¼ˆä¿ç•™ï¼‰
- `baseline_model/` - BCåŸºçº¿æ¨¡å‹ï¼ˆä¿ç•™ï¼‰

**è¡Œä¸º**:
- è·³è¿‡å½•åˆ¶ (`SKIP_RECORDING=true`)
- è·³è¿‡ BC è®­ç»ƒ (`SKIP_BC=true`)
- ä» BC åŸºçº¿å¼€å§‹ DAgger è¿­ä»£

**ä½¿ç”¨ç¤ºä¾‹**:
```bash
# æ¸…ç†DAggeræ•°æ®ï¼Œä»BCåŸºçº¿é‡æ–°å¼€å§‹
bash scripts/run_dagger_workflow.sh --task harvest_1_log --clean-restart

# æˆ–ä½¿ç”¨å…¼å®¹å‚æ•°
bash scripts/run_dagger_workflow.sh --task harvest_1_log --clean-dagger-only
```

**æ³¨æ„**: ä¸¤ä¸ªå‚æ•°æ•ˆæœç›¸åŒï¼Œéƒ½æ˜¯æ¸…ç†DAggeræ•°æ®å¹¶ä¿ç•™ä¸“å®¶æ¼”ç¤ºå’ŒBCåŸºçº¿ã€‚

### 3. Web UI ä¿®æ”¹

**åç«¯ (`app.py`)**:
- ä¿®æ”¹ `/api/dagger_iteration` æ¥å£ï¼Œæ–°å¢ `clean_data` å‚æ•°
- ä¿®æ”¹ `_dagger_iteration_task()` å‡½æ•°ï¼Œæ”¯æŒæ¸…ç†æ•°æ®
- å½“ `clean_data=True` æ—¶ï¼Œå‘è„šæœ¬ä¼ é€’ `--clean-restart` å‚æ•°

**å‰ç«¯ (`training.html`)**:
- åœ¨ DAgger è¿­ä»£å¯¹è¯æ¡†ä¸­æä¾›ä¸¤ä¸ªæ¸…æ™°çš„é€‰é¡¹ï¼š
- é€‰é¡¹è¯´æ˜ï¼š
  - **ğŸ”„ ç»§ç»­è¿­ä»£**: ä½¿ç”¨æœ€æ–°çš„DAggeræ¨¡å‹ç»§ç»­è®­ç»ƒï¼ˆå¦‚ä»ç¬¬3è½®ç»§ç»­ç¬¬4è½®ï¼‰
  - **ğŸ—‘ï¸ æ¸…ç†é‡å¯**: åˆ é™¤æ‰€æœ‰DAggeræ•°æ®ï¼Œä»BCåŸºçº¿é‡æ–°å¼€å§‹ç¬¬1è½®ï¼ˆä¿ç•™ä¸“å®¶æ¼”ç¤ºå’ŒBCåŸºçº¿ï¼‰

**é€»è¾‘æ”¹è¿›**:
- âŒ ç§»é™¤äº†"é‡æ–°å¼€å§‹ï¼ˆä¿ç•™å†å²æ•°æ®ï¼‰"é€‰é¡¹ï¼Œå› ä¸ºå®ƒä¼šå¯¼è‡´æ–‡ä»¶è¦†ç›–æ··ä¹±
- âœ… åªä¿ç•™ä¸¤ä¸ªæ¸…æ™°çš„é€‰é¡¹ï¼šç»§ç»­æˆ–æ¸…ç†é‡å¯

**ç”¨æˆ·ä½“éªŒ**:
1. ç‚¹å‡»"å¼€å§‹ DAgger è¿­ä»£"æŒ‰é’®
2. å¦‚æœå·²æœ‰è¿­ä»£æ¨¡å‹ï¼Œå¼¹å‡ºé€‰æ‹©å¯¹è¯æ¡†
3. ç”¨æˆ·å¯é€‰æ‹©æ¸…ç†é‡å¯é€‰é¡¹
4. ç³»ç»Ÿè‡ªåŠ¨è°ƒç”¨è„šæœ¬æ¸…ç†æ•°æ®å¹¶é‡æ–°å¼€å§‹

## å®‰å…¨æœºåˆ¶

æ‰€æœ‰æ¸…ç†æ“ä½œéƒ½ä½¿ç”¨äº†å®‰å…¨çš„ bash è¯­æ³•ï¼š

```bash
# æ£€æŸ¥ç›®å½•å­˜åœ¨ä¸”éç©º
if [ -d "$POLICY_STATES_DIR" ] && [ "$(ls -A $POLICY_STATES_DIR 2>/dev/null)" ]; then
    # ä½¿ç”¨ :? ç¡®ä¿å˜é‡éç©º
    rm -rf "${POLICY_STATES_DIR:?}/"*
fi
```

è¿™æ ·å¯ä»¥ï¼š
- é¿å…è¯¯åˆ é™¤æ ¹ç›®å½•
- æ£€æŸ¥ç›®å½•æ˜¯å¦å­˜åœ¨
- æ£€æŸ¥ç›®å½•æ˜¯å¦éç©º
- é˜²æ­¢å˜é‡æœªè®¾ç½®æ—¶æ‰§è¡Œå±é™©æ“ä½œ

## ç›®å½•ç»“æ„

```
data/tasks/harvest_1_log/
â”œâ”€â”€ expert_demos/          # ä¸“å®¶æ¼”ç¤ºï¼ˆæ°¸è¿œä¿ç•™ï¼Œéå¸¸çè´µï¼ï¼‰
â”œâ”€â”€ baseline_model/        # BCåŸºçº¿æ¨¡å‹ï¼ˆæ°¸è¿œä¿ç•™ï¼‰
â”œâ”€â”€ policy_states/         # ç­–ç•¥çŠ¶æ€ï¼ˆ--clean-restart ä¼šåˆ é™¤ï¼‰
â”œâ”€â”€ expert_labels/         # ä¸“å®¶æ ‡æ³¨ï¼ˆ--clean-restart ä¼šåˆ é™¤ï¼‰
â”œâ”€â”€ dagger/                # èšåˆæ•°æ®ï¼ˆ--clean-restart ä¼šåˆ é™¤ï¼‰
â””â”€â”€ dagger_model/          # DAggeræ¨¡å‹ï¼ˆ--clean-restart ä¼šåˆ é™¤ï¼‰
```

## ä½¿ç”¨åœºæ™¯

### åœºæ™¯1: ç»§ç»­è¿­ä»£è®­ç»ƒï¼ˆæ­£å¸¸æµç¨‹ï¼‰

**é—®é¢˜**: ç»§ç»­è¿­ä»£æ—¶ï¼Œæ”¶é›†é”™è¯¯çŠ¶æ€ç”¨çš„æ˜¯å“ªä¸ªæ¨¡å‹ï¼Ÿ

**ç­”æ¡ˆ**: ä½¿ç”¨**æœ€æ–°çš„DAggeræ¨¡å‹**ï¼ˆå¦‚æœå­˜åœ¨ï¼‰ï¼Œå¦åˆ™ä½¿ç”¨BCåŸºçº¿ã€‚

```bash
# å‡è®¾å½“å‰å·²æœ‰ dagger_iter_1.zip å’Œ dagger_iter_2.zip
# ç»§ç»­è¿­ä»£æ—¶ï¼Œä¼šä½¿ç”¨ dagger_iter_2.zip æ¥æ”¶é›†å¤±è´¥çŠ¶æ€
bash scripts/run_dagger_iteration.sh \
  --task harvest_1_log \
  --iterations 1

# è¿™ä¼šï¼š
# 1. ä½¿ç”¨ dagger_iter_2.zip è¿è¡Œå¹¶æ”¶é›†å¤±è´¥çŠ¶æ€
# 2. æ ‡æ³¨è¿™äº›å¤±è´¥çŠ¶æ€
# 3. èšåˆæ‰€æœ‰å†å²æ•°æ®ï¼ˆBCåŸºçº¿ + iter1 + iter2 + æ–°æ ‡æ³¨ï¼‰
# 4. è®­ç»ƒæ–°æ¨¡å‹ dagger_iter_3.zip
```

### åœºæ™¯2: BCåŸºçº¿æ•ˆæœå¥½ï¼Œä½†DAggerè¿­ä»£èµ°åäº†

```bash
# æ–¹å¼1ï¼šä½¿ç”¨workflowè„šæœ¬
bash scripts/run_dagger_workflow.sh \
  --task harvest_1_log \
  --clean-restart \
  --iterations 3

# æ–¹å¼2ï¼šä½¿ç”¨iterationè„šæœ¬
bash scripts/run_dagger_iteration.sh \
  --task harvest_1_log \
  --clean-restart \
  --iterations 1
```

### åœºæ™¯3: é€šè¿‡Web UIæ“ä½œ

1. æ‰“å¼€ `http://localhost:5000`
2. è¿›å…¥ä»»åŠ¡è¯¦æƒ…é¡µ
3. ç‚¹å‡»"å¼€å§‹ DAgger è¿­ä»£"
4. é€‰æ‹©"ğŸ—‘ï¸ æ¸…ç†é‡å¯"é€‰é¡¹
5. ç¡®è®¤å¼€å§‹

## æµ‹è¯•å»ºè®®

1. **æµ‹è¯•æ¸…ç†åŠŸèƒ½**:
   ```bash
   # å…ˆè¿è¡Œä¸€è½®è®­ç»ƒ
   bash scripts/run_dagger_iteration.sh --task test_task --iterations 1
   
   # æ£€æŸ¥ç”Ÿæˆçš„æ–‡ä»¶
   ls data/tasks/test_task/policy_states/
   ls data/tasks/test_task/expert_labels/
   ls data/tasks/test_task/dagger_model/
   
   # æ¸…ç†é‡å¯
   bash scripts/run_dagger_iteration.sh --task test_task --clean-restart
   
   # éªŒè¯æ–‡ä»¶å·²åˆ é™¤
   ls data/tasks/test_task/policy_states/  # åº”è¯¥ä¸ºç©º
   ```

2. **æµ‹è¯•Web UI**:
   - åˆ›å»ºæµ‹è¯•ä»»åŠ¡
   - è¿è¡Œå‡ è½®è¿­ä»£
   - æµ‹è¯•"æ¸…ç†é‡å¯"é€‰é¡¹
   - éªŒè¯æ•°æ®å·²æ¸…ç†

## é‡è¦è¯´æ˜

### ç»§ç»­è¿­ä»£çš„å·¥ä½œæµç¨‹

å½“é€‰æ‹©"ç»§ç»­è¿­ä»£"æ—¶ï¼š
1. ç³»ç»Ÿè‡ªåŠ¨æŸ¥æ‰¾æœ€æ–°çš„DAggeræ¨¡å‹ï¼ˆå¦‚ `dagger_iter_2.zip`ï¼‰
2. ä½¿ç”¨è¿™ä¸ªæ¨¡å‹è¿è¡Œæ¸¸æˆï¼Œæ”¶é›†å¤±è´¥çŠ¶æ€
3. å¯¹å¤±è´¥çŠ¶æ€è¿›è¡Œæ ‡æ³¨
4. åŸºäºæ‰€æœ‰å†å²æ•°æ®è®­ç»ƒæ–°æ¨¡å‹ï¼ˆå¦‚ `dagger_iter_3.zip`ï¼‰
5. é‡å¤è¿™ä¸ªè¿‡ç¨‹

**å…³é”®ç‚¹**: æ¯æ¬¡è¿­ä»£éƒ½åœ¨æ”¹è¿›**æœ€æ–°çš„æ¨¡å‹**ï¼Œè€Œä¸æ˜¯ä»BCåŸºçº¿é‡æ–°å¼€å§‹ã€‚

### æ¸…ç†é‡å¯ vs ç»§ç»­è¿­ä»£

| æ“ä½œ | ä½¿ç”¨æ¨¡å‹ | ä¿ç•™æ•°æ® | é€‚ç”¨åœºæ™¯ |
|-----|---------|---------|---------|
| ç»§ç»­è¿­ä»£ | æœ€æ–°DAggeræ¨¡å‹ | ä¿ç•™æ‰€æœ‰æ•°æ® | æ­£å¸¸è¿­ä»£ä¼˜åŒ– |
| æ¸…ç†é‡å¯ | BCåŸºçº¿ | åˆ é™¤DAggeræ•°æ® | è¿­ä»£èµ°åï¼Œé‡æ–°å¼€å§‹ |

## æ³¨æ„äº‹é¡¹

1. **æ•°æ®ä¸å¯æ¢å¤**: æ¸…ç†æ“ä½œä¼šæ°¸ä¹…åˆ é™¤æ•°æ®ï¼Œä½¿ç”¨å‰è¯·ç¡®è®¤
2. âœ… **ä¸“å®¶æ¼”ç¤ºæ°¸è¿œä¿ç•™**: `--clean-restart` ä¸ä¼šåˆ é™¤ä¸“å®¶æ¼”ç¤ºï¼ˆéå¸¸çè´µï¼‰
3. âœ… **BCåŸºçº¿æ°¸è¿œä¿ç•™**: `--clean-restart` ä¸ä¼šåˆ é™¤BCåŸºçº¿
4. **å®‰å…¨æ£€æŸ¥**: æ‰€æœ‰è„šæœ¬éƒ½æœ‰ç¯å¢ƒæ£€æŸ¥ï¼Œç¡®ä¿åœ¨æ­£ç¡®çš„condaç¯å¢ƒä¸­è¿è¡Œ

## ç›¸å…³æ–‡ä»¶

- `scripts/run_dagger_iteration.sh`
- `scripts/run_dagger_workflow.sh`
- `src/web/app.py`
- `src/web/templates/training.html`

## åç»­æ”¹è¿›

å¯èƒ½çš„æ”¹è¿›æ–¹å‘ï¼š

1. **å¤‡ä»½åŠŸèƒ½**: æ¸…ç†å‰è‡ªåŠ¨å¤‡ä»½æ•°æ®åˆ° `.backup/` ç›®å½•
2. **é€‰æ‹©æ€§æ¸…ç†**: å…è®¸ç”¨æˆ·é€‰æ‹©å…·ä½“è¦æ¸…ç†çš„è¿­ä»£è½®æ¬¡
3. **ç£ç›˜ç©ºé—´æç¤º**: æ¸…ç†å‰æ˜¾ç¤ºå°†é‡Šæ”¾çš„ç£ç›˜ç©ºé—´
4. **ç¡®è®¤å¯¹è¯æ¡†**: æ·»åŠ äºŒæ¬¡ç¡®è®¤ï¼Œé˜²æ­¢è¯¯æ“ä½œ
5. **æ¸…ç†æ—¥å¿—**: è®°å½•æ¸…ç†æ“ä½œçš„è¯¦ç»†æ—¥å¿—

## æ€»ç»“

é€šè¿‡æœ¬æ¬¡æ”¹è¿›ï¼ŒDAgger è®­ç»ƒæµç¨‹ç°åœ¨æ”¯æŒçµæ´»çš„æ•°æ®æ¸…ç†åŠŸèƒ½ï¼Œç”¨æˆ·å¯ä»¥æ ¹æ®å®é™…æƒ…å†µé€‰æ‹©ï¼š
- å®Œå…¨é‡æ–°å¼€å§‹ï¼ˆåŒ…æ‹¬å½•åˆ¶ï¼‰
- ä»…é‡æ–°å¼€å§‹ DAggerï¼ˆä¿ç•™BCåŸºçº¿ï¼‰
- ç»§ç»­ç°æœ‰è®­ç»ƒ

è¿™å¤§å¤§æé«˜äº†è®­ç»ƒæµç¨‹çš„çµæ´»æ€§å’Œå¯ç»´æŠ¤æ€§ã€‚


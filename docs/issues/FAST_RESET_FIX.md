# fast_reset参数修复

> **问题**: reset后世界没有重新生成，还是之前砍过的树

---

## 🐛 **问题描述**

### **现象**

```
用户反馈:
"触发env的done后，画面显示重新开始，但我转动视角发现还是之前生成的世界，
还有砍过的树，不确定这个reset是怎么实现的，我以为会重新刷新世界，
或者重新随机复活在一个地点"
```

**预期**: 每次reset应该生成**全新的世界**（新树、新地形、新位置）

**实际**: reset后还是**同一个世界**（树被砍了，地形一样）

---

## 🔍 **根本原因**

### **MineDojo的fast_reset参数**

```python
# 原代码
env = minedojo.make(
    task_id="harvest_1_log_forest",
    image_size=(160, 256),
    world_seed=None,
    fast_reset=True  # ❌ 问题在这里
)
```

### **fast_reset的两种模式**

| fast_reset | 行为 | 速度 | 数据多样性 |
|------------|------|------|-----------|
| **True** | 重用同一个世界，只重置玩家位置 | 快 ⚡ | 低 ❌ |
| **False** | 每次重新生成新世界 | 慢 🐌 | 高 ✅ |

---

### **fast_reset=True的行为**

```
第1次 reset():
  生成世界1（seed=12345）
  玩家出生在(100, 64, 200)
  树木位置: [(110, 64, 210), (105, 64, 195), ...]

玩家砍树，获得木头，done=True

第2次 reset():
  ❌ 仍然是世界1（seed=12345）
  ✅ 玩家位置重置为(100, 64, 200)
  ❌ 树木仍然是砍过的状态
  ❌ 地形完全一样

第3次 reset():
  ❌ 还是世界1...
```

**结果**: 数据多样性极低，所有round都在同一个世界里 ❌

---

### **fast_reset=False的行为**

```
第1次 reset():
  生成世界1（seed=随机）
  玩家出生在(100, 64, 200)
  树木位置: [(110, 64, 210), (105, 64, 195), ...]

玩家砍树，获得木头，done=True

第2次 reset():
  ✅ 生成世界2（seed=随机）
  ✅ 玩家出生在(245, 68, 150)（随机位置）
  ✅ 树木位置: [(250, 68, 160), ...] （全新的树）
  ✅ 地形完全不同

第3次 reset():
  ✅ 生成世界3（seed=随机）
  ...
```

**结果**: 数据多样性高，每个round都是全新的世界 ✅

---

## ✅ **修复方案**

```python
# ❌ 修复前
env = minedojo.make(
    task_id="harvest_1_log_forest",
    image_size=(160, 256),
    world_seed=None,
    fast_reset=True  # 重用世界
)

# ✅ 修复后
env = minedojo.make(
    task_id="harvest_1_log_forest",
    image_size=(160, 256),
    world_seed=None,
    fast_reset=False  # 每次重新生成世界
)
```

---

## 📊 **修复前后对比**

### **修复前（fast_reset=True）**

```
round_0: 世界A，位置(100, 64, 200)，砍树
round_1: 世界A，位置(100, 64, 200)，树已被砍 ❌
round_2: 世界A，位置(100, 64, 200)，树已被砍 ❌
round_3: 世界A，位置(100, 64, 200)，树已被砍 ❌

数据多样性: 极低 ❌
训练效果: 差（过拟合同一场景）❌
```

---

### **修复后（fast_reset=False）**

```
round_0: 世界A，位置(100, 64, 200)，新树 ✅
round_1: 世界B，位置(245, 68, 150)，新树 ✅
round_2: 世界C，位置(180, 65, 300)，新树 ✅
round_3: 世界D，位置(220, 70, 100)，新树 ✅

数据多样性: 高 ✅
训练效果: 好（泛化能力强）✅
```

---

## ⚠️ **权衡考虑**

### **fast_reset=False的代价**

```
每次reset的时间:
- fast_reset=True:  约1-2秒（快速）
- fast_reset=False: 约5-10秒（慢，需要重新生成世界）
```

**但是**，对于录制专家数据来说：
- ✅ **数据多样性** 比速度更重要
- ✅ 每个round可能要录制几百帧（几十秒），多等5秒完全可以接受
- ✅ 避免过拟合同一场景

**结论**: `fast_reset=False` 是正确选择 ✅

---

## 🧪 **验证方法**

### **测试1: 观察世界变化**

```bash
python tools/record_manual_chopping.py --max-rounds 3

# round_0: 完成任务
# 观察: 树木位置、地形特征

# round_1: 开始
# 观察: 应该看到完全不同的地形 ✅
# 观察: 树木位置应该不同 ✅
# 观察: 出生位置可能不同 ✅

# round_2: 开始
# 观察: 又是新的世界 ✅
```

---

### **测试2: 检查reset时间**

```
修复前（fast_reset=True）:
  重置环境中...
  ✓ 环境已重置（耗时: 1秒）

修复后（fast_reset=False）:
  重置环境中...
  ✓ 环境已重置（耗时: 5-10秒）⏱️

虽然慢一点，但每次都是新世界 ✅
```

---

## 💡 **为什么之前没发现**

1. **`world_seed=None`**: 虽然设置了随机种子，但`fast_reset=True`会忽略它
2. **视觉不明显**: 第一次可能没注意到树的状态
3. **文档不清晰**: MineDojo文档对`fast_reset`的说明较少

---

## 📚 **MineDojo参数说明**

### **完整参数**

```python
env = minedojo.make(
    task_id="harvest_1_log_forest",
    
    # 图像大小
    image_size=(160, 256),  # (height, width)
    
    # 世界种子
    world_seed=None,  # None=随机，整数=固定种子
    
    # Reset模式
    fast_reset=False,  # False=重新生成世界，True=重用世界
    
    # 其他常用参数
    # specified_biome="forest",  # 指定生物群系
    # start_position=(x, y, z),  # 指定出生位置
)
```

---

### **参数组合建议**

| 用途 | world_seed | fast_reset | 说明 |
|------|-----------|-----------|------|
| **训练数据收集** | `None` | `False` | 最大多样性 ✅ |
| **测试/调试** | `42` | `True` | 可重复性 |
| **快速迭代** | `None` | `True` | 速度优先 |

**本项目**: 训练数据收集 → `world_seed=None` + `fast_reset=False` ✅

---

## ✅ **修复验证清单**

- [x] 修改`fast_reset=False`
- [x] 添加注释说明
- [x] 创建修复文档
- [ ] 用户测试验证（待用户确认）

---

## 🎯 **预期效果**

修复后，每次reset应该看到：
1. ✅ 完全不同的地形
2. ✅ 不同位置的树木
3. ✅ 可能不同的出生位置
4. ✅ 新鲜的、未被砍的树

虽然reset会慢一点（5-10秒），但每个round都是全新的世界，数据多样性大大提高！

---

**修复日期**: 2025-10-21  
**修复状态**: ✅ 已完成  
**测试状态**: ⏳ 待用户验证


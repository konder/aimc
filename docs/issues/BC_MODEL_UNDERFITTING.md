# BCæ¨¡å‹æ¬ æ‹Ÿåˆé—®é¢˜è¯Šæ–­ä¸è§£å†³æ–¹æ¡ˆ

> **é—®é¢˜**: BCè¯„ä¼°æ—¶è§’è‰²å‡ ä¹é™æ­¢ä¸åŠ¨ï¼Œè™½ç„¶é¢„æµ‹åŠ¨ä½œæ˜¯"å‰è¿›"  
> **çŠ¶æ€**: è¯Šæ–­å®Œæˆï¼Œå¾…éªŒè¯è§£å†³æ–¹æ¡ˆ  
> **æ—¥æœŸ**: 2025-10-23

---

## ğŸ“‹ é—®é¢˜æè¿°

### ç—‡çŠ¶
- BCæ¨¡å‹è¯„ä¼°æ—¶ï¼ŒæŒç»­é¢„æµ‹åŠ¨ä½œ `[1 0 0 12 12 0 0 0]` (å‰è¿›)
- ä½†æ¸¸æˆç”»é¢ä¸­è§’è‰²å‡ ä¹ä¸åŠ¨
- å¶å°”åœ¨æ°´é¢è·³è·ƒï¼Œå¤§éƒ¨åˆ†æ—¶é—´å¡ä½

### æ¸¸æˆç¯å¢ƒ
- ä»»åŠ¡: `harvest_1_log`
- ç”Ÿç‰©ç¾¤ç³»: æ²™æ¼ 
- å¥åº·å€¼: æ»¡

---

## âœ… å·²æ’é™¤çš„é—®é¢˜

### 1. æ•°æ®è´¨é‡ âœ…

é€šè¿‡ `tools/analyze_bc_data.py` åˆ†æï¼š

```
æ€»æ•°æ®: 101 episodes, 765 frames
å‰è¿›å¸§: 304 (39.7%)  â† åˆç†
é™æ­¢å¸§: 0   (0.0%)   â† ä¼˜ç§€ï¼
æ”»å‡»å¸§: 398 (52.0%)  â† åˆç†
è·³è·ƒå¸§: 8   (1.0%)   â† åä½ä½†å¯æ¥å—
è§†è§’ç§»åŠ¨: 81 (10.6%) â† åˆç†
```

**ç»“è®º:** æ•°æ®è´¨é‡è‰¯å¥½ï¼Œä½¿ç”¨äº† `--skip-idle-frames`ï¼Œæ²¡æœ‰é™æ­¢å¸§é—®é¢˜ã€‚

---

### 2. åŠ¨ä½œæ˜ å°„ âœ…

```python
å½•åˆ¶æ•°æ®: [1 0 0 12 12 0 0 0] = å‰è¿›
æ¨¡å‹é¢„æµ‹: [1 0 0 12 12 0 0 0] = å‰è¿›
```

**ç»“è®º:** åŠ¨ä½œç©ºé—´æ˜ å°„æ­£ç¡®ï¼Œä¸æ˜¯æ ¼å¼é—®é¢˜ã€‚

---

## âš ï¸ çœŸæ­£çš„é—®é¢˜ï¼šBCæ¨¡å‹æ¬ æ‹Ÿåˆ

### æ ¸å¿ƒåŸå› 

#### 1. æ¨¡å‹æ²¡æœ‰å­¦ä¼š"è§†è§‰â†’åŠ¨ä½œ"çš„æ˜ å°„

**è§‚å¯Ÿ:**
- æ•°æ®åˆ†å¸ƒ: 52%æ”»å‡»ï¼Œ40%å‰è¿›ï¼Œ11%è§†è§’ï¼Œ1%è·³è·ƒ
- æ¨¡å‹é¢„æµ‹: 100%å‰è¿›

**é—®é¢˜:**
æ¨¡å‹åªå­¦åˆ°äº†"å‰è¿›æ˜¯é«˜é¢‘åŠ¨ä½œ"çš„ç»Ÿè®¡è§„å¾‹ï¼Œè€Œæ²¡æœ‰å­¦ä¼šï¼š
- çœ‹åˆ°æ ‘ â†’ åº”è¯¥å‰è¿›+æ”»å‡»
- æ²¡çœ‹åˆ°æ ‘ â†’ åº”è¯¥è°ƒæ•´è§†è§’
- é è¿‘æ ‘ â†’ åº”è¯¥æ”»å‡»
- åœ¨æ°´é‡Œ â†’ åº”è¯¥è·³è·ƒ+å‰è¿›

#### 2. ä¸ºä»€ä¹ˆ"å‰è¿›"ä½†è§’è‰²ä¸åŠ¨ï¼Ÿ

**Minecraftæ¸¸æˆæœºåˆ¶:**
- å•çº¯"å‰è¿›"é‡åˆ°éšœç¢ä¼šå¡ä½
- åœ¨æ°´é‡Œï¼Œå•çº¯å‰è¿›ç§»åŠ¨å¾ˆæ…¢
- éœ€è¦ç»„åˆåŠ¨ä½œæ‰èƒ½æœ‰æ•ˆç§»åŠ¨ï¼š
  - å‰è¿› + è·³è·ƒï¼ˆæ°´é‡Œï¼‰
  - å‰è¿› + è§†è§’è°ƒæ•´ï¼ˆç»•è¿‡éšœç¢ï¼‰
  - å‰è¿› + æ”»å‡»ï¼ˆæ¸…é™¤æ ‘æœ¨ï¼‰

**BCæ¨¡å‹çš„é—®é¢˜:**
åªå­¦ä¼šè¾“å‡ºå•ä¸€åŠ¨ä½œ"å‰è¿›"ï¼Œæ— æ³•æ ¹æ®ç¯å¢ƒé€‚åº”æ€§åœ°ç»„åˆåŠ¨ä½œã€‚

---

### BCè®­ç»ƒå‚æ•°åˆ†æ

**å½“å‰é…ç½®:**
```python
epochs = 50
learning_rate = 3e-4
batch_size = 32
æ•°æ®é‡: 765 frames
```

**é—®é¢˜:**
- **Epochså¤ªå°‘**: å¯¹äºpixel-basedè§‚å¯Ÿç©ºé—´ï¼Œ50ä¸ªepochsè¿œè¿œä¸å¤Ÿ
- **æ•°æ®é‡åå°‘**: 765å¸§å¯¹äºå­¦ä¹ å¤æ‚çš„è§†è§‰ç­–ç•¥ä¸è¶³
- **æ²¡æœ‰å¤„ç†ç±»åˆ«ä¸å¹³è¡¡**: æ”»å‡»52%ï¼Œå‰è¿›40%ï¼Œä½†æ¨¡å‹å€¾å‘è¾“å‡ºå‰è¿›

---

## ğŸ’¡ è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1: å¢åŠ è®­ç»ƒè½®æ•° â­ (ç«‹å³å°è¯•)

**ç†è®ºä¾æ®:**
- è§†è§‰ç­–ç•¥å­¦ä¹ éœ€è¦æ›´å¤šè¿­ä»£
- NatureCNNéœ€è¦å……åˆ†è®­ç»ƒæ‰èƒ½æå–æœ‰æ•ˆç‰¹å¾

**æ¨èé…ç½®:**
```bash
epochs = 200-500
learning_rate = 3e-4  (ä¿æŒä¸å˜)
batch_size = 32       (ä¿æŒä¸å˜)
```

**å‘½ä»¤:**
```bash
python src/training/train_bc.py \
    --data-dir data/expert_demos/harvest_1_log \
    --output-path checkpoints/dagger/harvest_1_log/bc_baseline_200ep.zip \
    --epochs 200 \
    --batch-size 32 \
    --device mps
```

**é¢„æœŸ:**
- è®­ç»ƒæ—¶é—´: 10-20åˆ†é’Ÿ
- Lossåº”è¯¥æŒç»­ä¸‹é™
- æ¨¡å‹å¼€å§‹é¢„æµ‹æ›´å¤šæ ·åŒ–çš„åŠ¨ä½œ

**è¯„ä¼°:**
```bash
python tools/dagger/evaluate_policy.py \
    --model checkpoints/dagger/harvest_1_log/bc_baseline_200ep.zip \
    --episodes 10
```

---

### æ–¹æ¡ˆ2: é™ä½å­¦ä¹ ç‡ + å¢åŠ è®­ç»ƒæ—¶é—´

**ç†è®ºä¾æ®:**
- æ›´å°çš„å­¦ä¹ ç‡é¿å…è¿‡å¿«æ”¶æ•›åˆ°å±€éƒ¨æœ€ä¼˜
- æ›´ç²¾ç»†çš„æ¢¯åº¦æ›´æ–°

**æ¨èé…ç½®:**
```bash
epochs = 300
learning_rate = 1e-4  (é™ä½)
batch_size = 32
```

**å‘½ä»¤:**
```bash
python src/training/train_bc.py \
    --data-dir data/expert_demos/harvest_1_log \
    --output-path checkpoints/dagger/harvest_1_log/bc_baseline_lr1e4.zip \
    --epochs 300 \
    --batch-size 32 \
    --learning-rate 1e-4 \
    --device mps
```

---

### æ–¹æ¡ˆ3: å¢åŠ æ•°æ®é‡ (æœ€æœ‰æ•ˆï¼Œä½†è´¹æ—¶)

**ç†è®ºä¾æ®:**
- BCæ˜¯æœ‰ç›‘ç£å­¦ä¹ ï¼Œæ•°æ®é‡æ˜¯æ€§èƒ½ä¸Šé™
- éœ€è¦è¦†ç›–æ›´å¤šåœºæ™¯å’ŒçŠ¶æ€

**ç›®æ ‡:**
```
å½“å‰: 101 episodes, 765 frames
ç›®æ ‡: 200+ episodes, 2000+ frames
```

**éœ€è¦è¦†ç›–çš„åœºæ™¯:**
- ä¸åŒè§’åº¦çœ‹æ ‘ï¼ˆæ­£é¢ã€ä¾§é¢ã€è¿œå¤„ã€è¿‘å¤„ï¼‰
- ä¸åŒç±»å‹çš„æ ‘ï¼ˆOakã€Spruceã€Birchç­‰ï¼‰
- ä¸åŒåœ°å½¢ï¼ˆå¹³åœ°ã€å±±å¡ã€æ°´è¾¹ï¼‰
- ä¸åŒèµ·å§‹ä½ç½®

**å‘½ä»¤:**
```bash
bash scripts/run_dagger_workflow.sh \
    --task harvest_1_log \
    --num-episodes 100 \
    --append-recording
```

---

### æ–¹æ¡ˆ4: ä½¿ç”¨DAggerè¿­ä»£ â­â­â­ (æ ¸å¿ƒæ–¹æ¡ˆ)

**BCçš„æ ¹æœ¬å±€é™:**
- åªèƒ½å­¦ä¹ ä¸“å®¶æ¼”ç¤ºçš„çŠ¶æ€åˆ†å¸ƒ
- é‡åˆ°æœªè§è¿‡çš„çŠ¶æ€ï¼ˆå¦‚å¡åœ¨å¢™è§’ï¼‰æ— æ³•å¤„ç†
- å­˜åœ¨"Covariate Shift"é—®é¢˜

**DAggerçš„ä¼˜åŠ¿:**
1. è®©æ¨¡å‹è‡ªå·±è¿è¡Œï¼Œæ”¶é›†å®ƒä¼šé‡åˆ°çš„çŠ¶æ€
2. ä¸“å®¶å¯¹è¿™äº›"éš¾"çŠ¶æ€è¿›è¡Œæ ‡æ³¨
3. æ¨¡å‹å­¦ä¼šä»é”™è¯¯ä¸­æ¢å¤

**æµç¨‹:**
```
BCæ¨¡å‹è¿è¡Œ â†’ æ”¶é›†"å¡ä½"çš„çŠ¶æ€ â†’ äººå·¥æ ‡æ³¨æ­£ç¡®åŠ¨ä½œ â†’ 
é‡æ–°è®­ç»ƒ â†’ æ¨¡å‹å­¦ä¼šå¤„ç†è¿™äº›çŠ¶æ€ â†’ é‡å¤
```

**å‘½ä»¤:**
```bash
bash scripts/run_dagger_workflow.sh \
    --task harvest_1_log \
    --skip-recording \
    --skip-bc \
    --continue-from checkpoints/dagger/harvest_1_log/bc_baseline.zip \
    --start-iteration 1 \
    --iterations 3
```

**æ ‡æ³¨é‡ç‚¹:**
- æ¨¡å‹ä¸€ç›´å‰è¿›æ’å¢™ â†’ æ ‡æ³¨"è°ƒæ•´è§†è§’"æˆ–"åé€€"
- æ¨¡å‹åˆ°æ ‘å‰ä¸æ”»å‡» â†’ æ ‡æ³¨"æ”»å‡»"
- æ¨¡å‹åœ¨æ°´é‡Œä¸è·³ â†’ æ ‡æ³¨"å‰è¿›+è·³è·ƒ"

---

## ğŸ¯ æ¨èè¡ŒåŠ¨è®¡åˆ’

### é˜¶æ®µ1: å¿«é€ŸéªŒè¯ï¼ˆç«‹å³æ‰§è¡Œï¼‰

```bash
# 1. é‡æ–°è®­ç»ƒBC (200 epochs)
python src/training/train_bc.py \
    --data-dir data/expert_demos/harvest_1_log \
    --output-path checkpoints/dagger/harvest_1_log/bc_baseline_200ep.zip \
    --epochs 200 \
    --device mps

# 2. è¯„ä¼°
python tools/dagger/evaluate_policy.py \
    --model checkpoints/dagger/harvest_1_log/bc_baseline_200ep.zip \
    --episodes 10
```

**åˆ¤æ–­æ ‡å‡†:**
- âœ… å¦‚æœåŠ¨ä½œå¤šæ ·åŒ–ï¼Œç»§ç»­å¢åŠ epochsåˆ°500
- âŒ å¦‚æœä»ç„¶å•ä¸€åŠ¨ä½œï¼Œè¿›å…¥é˜¶æ®µ2

---

### é˜¶æ®µ2: DAggerè¿­ä»£ï¼ˆå¦‚æœé˜¶æ®µ1æ— æ•ˆï¼‰

```bash
bash scripts/run_dagger_workflow.sh \
    --task harvest_1_log \
    --skip-recording \
    --skip-bc \
    --continue-from checkpoints/dagger/harvest_1_log/bc_baseline_200ep.zip \
    --start-iteration 1 \
    --iterations 5
```

**é¢„æœŸ:**
- è¿­ä»£1: æ”¶é›†å¤§é‡"å¡ä½"çŠ¶æ€ï¼ŒæˆåŠŸç‡å¯èƒ½ä»å¾ˆä½
- è¿­ä»£2-3: å¼€å§‹å­¦ä¼šåŸºæœ¬åŠ¨ä½œç»„åˆ
- è¿­ä»£4-5: æˆåŠŸç‡æ˜¾è‘—æå‡

---

### é˜¶æ®µ3: æ•°æ®å¢å¼ºï¼ˆé•¿æœŸæ–¹æ¡ˆï¼‰

```bash
# ç»§ç»­å½•åˆ¶æ›´å¤šepisode
bash scripts/run_dagger_workflow.sh \
    --task harvest_1_log \
    --num-episodes 100 \
    --append-recording
```

ç„¶åä»å¤´é‡æ–°è®­ç»ƒBCå’ŒDAggerã€‚

---

## ğŸ“Š ä¸ºä»€ä¹ˆBCä¼šå­¦åˆ°"ä¸€ç›´å‰è¿›"ï¼Ÿ

### ä»æ¨¡å‹è§’åº¦ç†è§£

**BCçš„è®­ç»ƒç›®æ ‡:**
```
æœ€å°åŒ–: CrossEntropy(predicted_action, expert_action)
```

**å¦‚æœæ¨¡å‹è§†è§‰ç‰¹å¾æå–ä¸è¶³:**
```python
# ç®€åŒ–çš„ä¼ªä»£ç 
def policy(observation):
    # è§†è§‰ç‰¹å¾æå–å¤±è´¥
    features = extract_features(obs)  # æå–çš„ç‰¹å¾ä¿¡æ¯é‡ä¸è¶³
    
    # æ— æ³•æ ¹æ®ç”»é¢åŒºåˆ†åœºæ™¯ï¼Œé€€åŒ–ä¸ºç»Ÿè®¡çŒœæµ‹
    if random() < 0.4:
        return "forward"  # 40%æ¦‚ç‡
    elif random() < 0.52:
        return "attack"   # 52%æ¦‚ç‡
    ...
```

**å®é™…æƒ…å†µ:**
æ¨¡å‹å¯èƒ½å­¦åˆ°äº†ä¸€ä¸ª"å®‰å…¨"çš„ç­–ç•¥ï¼š
- "å‰è¿›"åœ¨40%çš„æ—¶é—´æ˜¯æ­£ç¡®çš„
- ç›¸æ¯”å…¶ä»–æ›´å¤æ‚çš„åŠ¨ä½œç»„åˆï¼Œ"å‰è¿›"æ›´å®¹æ˜“å­¦ä¹ 
- æ¨¡å‹é€‰æ‹©äº†æœ€ç®€å•ä½†æ¬¡ä¼˜çš„ç­–ç•¥

### è§£å†³æ–¹æ³•

**å¢åŠ è®­ç»ƒå¼ºåº¦:**
- æ›´å¤šepochs â†’ å¼ºåˆ¶æ¨¡å‹å­¦ä¹ æ›´å¤æ‚çš„ç‰¹å¾
- æ›´ä½å­¦ä¹ ç‡ â†’ æ›´ç²¾ç»†çš„å­¦ä¹ 

**å¢åŠ æ•°æ®å¤šæ ·æ€§:**
- æ›´å¤šåœºæ™¯ â†’ æ¨¡å‹æ— æ³•åªé "å‰è¿›"åº”å¯¹æ‰€æœ‰æƒ…å†µ
- DAgger â†’ å¼ºåˆ¶æ¨¡å‹é¢å¯¹å®ƒä¸æ“…é•¿çš„çŠ¶æ€

---

## ğŸ“ˆ é¢„æœŸæ•ˆæœå¯¹æ¯”

### å½“å‰BCæ¨¡å‹ï¼ˆ50 epochsï¼‰
```
åŠ¨ä½œåˆ†å¸ƒ:
  å‰è¿›: 95%
  å…¶ä»–: 5%

æˆåŠŸç‡: 0-5%
```

### æ”¹è¿›åBCæ¨¡å‹ï¼ˆ200 epochsï¼‰
```
åŠ¨ä½œåˆ†å¸ƒ:
  å‰è¿›: 40-50%
  æ”»å‡»: 30-40%
  è§†è§’: 10-15%
  è·³è·ƒ: 5%

æˆåŠŸç‡: 10-20%
```

### DAggerè¿­ä»£3è½®å
```
åŠ¨ä½œåˆ†å¸ƒ:
  æ ¹æ®åœºæ™¯åŠ¨æ€è°ƒæ•´

æˆåŠŸç‡: 30-50%
```

---

## ğŸ”§ è°ƒè¯•å·¥å…·

### 1. åˆ†æBCè®­ç»ƒæ•°æ®
```bash
python tools/analyze_bc_data.py
```

### 2. è§‚å¯ŸBCè®­ç»ƒè¿‡ç¨‹
```bash
# è®­ç»ƒæ—¶è§‚å¯Ÿlosså˜åŒ–
# å¦‚æœloss<0.5åä¸å†ä¸‹é™ï¼Œè¯´æ˜å·²æ”¶æ•›
# å¦‚æœlossæŒç»­ä¸‹é™ï¼Œè¯´æ˜éœ€è¦æ›´å¤šepochs
```

### 3. è¯„ä¼°æ—¶æ‰“å°è¯¦ç»†åŠ¨ä½œ
```bash
# åœ¨evaluate_policy.pyä¸­å·²ç»æ‰“å°äº†é¢„æµ‹åŠ¨ä½œ
# è§‚å¯ŸåŠ¨ä½œçš„å¤šæ ·æ€§
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- `docs/guides/DAGGER_DETAILED_GUIDE.md` - DAggerè¯¦ç»†æŒ‡å—
- `docs/guides/DAGGER_LABELING_STRATEGY.md` - DAggeræ ‡æ³¨ç­–ç•¥
- `docs/technical/DAGGER_CNN_ARCHITECTURE.md` - BC/DAggerä½¿ç”¨çš„CNNæ¶æ„
- `tools/analyze_bc_data.py` - BCæ•°æ®åˆ†æå·¥å…·

---

## âœ… éªŒæ”¶æ ‡å‡†

### BCè®­ç»ƒæˆåŠŸçš„æ ‡å¿—

**è®­ç»ƒè¿‡ç¨‹:**
- Lossä»2-3é™åˆ°0.5ä»¥ä¸‹
- Lossæ›²çº¿å¹³æ»‘ä¸‹é™
- æ— NaNæˆ–çˆ†ç‚¸

**è¯„ä¼°æ•ˆæœ:**
- åŠ¨ä½œåˆ†å¸ƒæ¥è¿‘è®­ç»ƒæ•°æ®åˆ†å¸ƒ
- è‡³å°‘50%çš„episodesä¸­æœ‰æ”»å‡»åŠ¨ä½œ
- è‡³å°‘30%çš„episodesä¸­æœ‰è§†è§’è°ƒæ•´
- æˆåŠŸç‡ >10%

**å¦‚æœä¸æ»¡è¶³:**
ç»§ç»­å¢åŠ epochsæˆ–è¿›å…¥DAggerè¿­ä»£

---

**æœ€åæ›´æ–°**: 2025-10-23  
**ä¸‹æ¬¡å®¡æŸ¥**: éªŒè¯æ–¹æ¡ˆ1æ•ˆæœåæ›´æ–°


# 🎓 DAgger标注策略指南

## 🚨 常见陷阱：过度标注视角调整

### **问题场景**

你在标注时遇到：
```
帧1: 看不到树，策略=前进
     你的直觉: 应该左转找树
     你标注: 视角左移 (L键)

帧2: (还是帧1的画面，因为动作还没执行)
     你的直觉: 继续左转
     你标注: 视角左移 (L键)

帧3-5: 连续标注视角左移...
```

### **导致的问题**

模型学到：
```
"看不到树" -> "持续左移视角"
```

评估时表现：
- ❌ 原地转圈
- ❌ 很少前进
- ❌ 从不攻击树

---

## ✅ 正确的标注策略

### **策略1: 视角调整 + 前进（推荐）⭐**

**核心思想**: **环视是短期行为，移动是主要策略**

```
帧1: 看不到树，策略=前进
     你的判断: 需要稍微左转找树，同时继续前进
     你标注: J (向左看) 或者 自定义组合键 "向左看+前进"

帧2: (画面开始变化)
     你的判断: 已经开始左转了，继续前进找树
     你标注: W (前进) 或 P (如果策略已经是前进)

帧3: (继续变化)
     你的判断: 继续前进
     你标注: W (前进)

帧4: 看到树了！
     你的判断: 调整视角对准树
     你标注: L (向右看) 微调

帧5: 树在视野中心
     你的判断: 前进靠近
     你标注: W (前进)
```

**关键点**:
- ✅ 视角调整**最多1-2帧**
- ✅ 立即切换回**前进**
- ✅ 主要策略是**前进+环视**，而不是**原地转圈**

---

### **策略2: 使用P键（保持策略）⭐**

如果策略是**前进**，很多时候应该**保持前进**：

```
帧1: 看不到树，策略=前进
     你的判断: 虽然看不到树，但应该继续探索前进
     你标注: P (保持策略 - 前进)

帧2-5: 策略=前进
     你的判断: 继续前进探索
     你标注: P, P, P, P

帧6: 看到树了！策略=前进
     你的判断: 继续前进靠近
     你标注: P
```

**何时使用P键**:
- ✅ 策略正在前进探索 -> P
- ✅ 策略正在靠近树 -> P
- ✅ 策略正在攻击树 -> P
- ❌ 策略在原地转圈 -> 改为W（前进）

---

### **策略3: 跳过（N键）+ 关键帧标注**

对于**重复的相似画面**，只标注关键帧：

```
帧1: 看不到树，策略=前进
     你的判断: 需要左转
     你标注: J (向左看)

帧2-4: (画面变化很小，还在左转)
     你的判断: 这些帧是视角调整的过渡帧
     你标注: N, N, N (跳过)

帧5: 看到树了！
     你的判断: 关键帧！
     你标注: W (前进)
```

**何时跳过（N键）**:
- ✅ 连续相似的过渡帧
- ✅ 视角调整过程中的中间帧
- ✅ 不确定应该做什么的帧

---

## 📋 具体场景示例

### **场景1: 完全看不到树（刚开始）**

**错误标注** ❌:
```
帧1-10: 连续标注 L (向左看)
```
结果：模型学会原地转圈

**正确标注** ✅:
```
帧1: J (向左看) - 只调整1帧
帧2-10: W (前进) 或 P (如果策略是前进)
```
结果：模型学会前进+偶尔环视

---

### **场景2: 树在视野边缘**

**错误标注** ❌:
```
帧1-5: 连续标注 L (向右看)，想对准树
```
结果：模型学会过度调整视角

**正确标注** ✅:
```
帧1: L (向右看) - 微调1帧
帧2: W (前进) - 边走边调整
帧3: L (向右看) - 再微调1帧
帧4-5: W (前进) 或 Q (前进+攻击)
```
结果：模型学会边移动边调整

---

### **场景3: 树在正前方，但距离远**

**错误标注** ❌:
```
帧1-3: I/K (上下调整视角)
```
结果：模型在远处就开始调整视角

**正确标注** ✅:
```
帧1-10: W (前进) 或 P
帧11: 靠近后，I (向下看) - 1帧调整
帧12-15: Q (前进+攻击)
```
结果：模型学会先靠近再调整

---

### **场景4: 正在攻击树**

**错误标注** ❌:
```
策略=攻击，但你觉得应该同时前进
帧1-5: Q (前进+攻击)
```
结果：可能导致模型学会过度前进，撞到树上卡住

**正确标注** ✅:
```
策略=攻击
帧1-5: P (保持策略)
```
结果：模型学会在合适距离攻击

---

## 🎯 标注黄金法则

### **法则1: 1-2-10规则**

- **1帧**: 视角调整（最多2帧）
- **2帧**: 过渡/等待
- **10帧**: 前进/攻击等主要动作

**比例**: 视角调整应该<20%，前进应该>60%

---

### **法则2: 主动探索优先**

```
不确定哪里有树？
-> 答案：前进探索！（不是原地转圈）
```

**标注选择**:
- ✅ W (前进) - 主动探索
- ✅ P (保持策略前进)
- ❌ 连续 J/L (原地转圈找树)

---

### **法则3: P键是你的好朋友**

如果策略正在做**合理的事情**（即使不是最优），使用P键：

```
策略=前进，但方向不是最优
-> 你标注: P (前进总比原地转圈好)

策略=前进+攻击，虽然树不在正中心
-> 你标注: P (大方向对了)
```

**P键使用场景**:
- ✅ 策略在前进（不管方向）
- ✅ 策略在攻击树（不管是否对准）
- ✅ 策略在做"差不多对"的事情

---

### **法则4: 从任务目标反推**

**任务目标**: 砍树获得木头

**拆解**:
1. 找到树（10-30步）
2. 靠近树（5-15步）
3. 对准树（1-3步）
4. 攻击树（10-30步）

**标注分配**:
- 60-70%: 前进（W, Q）
- 20-30%: 攻击（F, Q）
- 5-10%: 视角调整（I/J/K/L）
- 0-5%: 跳跃（R, G）

**检查你的标注**:
```bash
# 如果你的标注中：
视角调整 > 30% -> ❌ 太多了！
前进 < 50% -> ❌ 太少了！
```

---

## 📊 标注质量自检

### **检查1: 统计你的标注分布**

标注100个状态后，统计一下：

```
W (前进):          40次 (40%)
Q (前进+攻击):     15次 (15%)
F (攻击):          10次 (10%)
P (保持策略):      20次 (20%)
J/L (左右看):      8次  (8%)
I/K (上下看):      3次  (3%)
N (跳过):          4次  (4%)
```

**健康的分布** ✅:
- 前进相关（W+Q+R）: 50-70%
- 攻击相关（F+Q+G）: 20-40%
- 视角调整（I/J/K/L）: <15%
- 保持策略（P）: 20-40%

**不健康的分布** ❌:
- 视角调整 > 30%
- 前进 < 40%
- P键使用 < 10%（说明你在过度干预）

---

### **检查2: 连续性检查**

看你的标注序列：

**不好的序列** ❌:
```
L, L, L, L, L, W, L, L, L  # 过多视角调整
```

**好的序列** ✅:
```
L, W, W, P, P, W, Q, Q, P  # 主要是前进
```

---

### **检查3: 策略一致性**

如果你发现自己：
- 连续3帧以上标注**同样的视角调整** -> ❌ 有问题
- 连续10帧以上标注**前进相关** -> ✅ 正常
- 连续5帧以上标注**攻击相关** -> ✅ 正常

---

## 🛠️ 实用技巧

### **技巧1: 想象你在玩游戏**

如果你自己玩Minecraft找树砍树：
1. 你会原地转5圈找树吗？❌
2. 你会边走边转头找树吗？✅

**标注时也应该这样！**

---

### **技巧2: 快进思维**

标注时想象：
```
"如果连续执行我标注的这10个动作，
agent会在哪里？在做什么？"
```

如果答案是"原地转圈"，那说明你标注的视角调整太多了！

---

### **技巧3: 使用组合键**

创建新的组合键（可以在`label_states.py`中添加）：

```python
# 环视+前进组合
'u': [1, 0, 0, 12, 8, 0, 0, 0],   # 前进+向左看
'o': [1, 0, 0, 12, 16, 0, 0, 0],  # 前进+向右看
```

这样可以避免"要么只转视角，要么只前进"的问题。

---

### **技巧4: 分批标注+评估**

```bash
# 标注50个状态
python tools/dagger/label_states.py ... 

# 训练
python src/training/train_dagger.py ...

# 立即评估
python tools/dagger/evaluate_policy.py ...

# 如果agent原地转圈 -> 你的视角标注太多了
# 调整下一批50个状态的标注策略
```

---

## 📈 预期效果

### **正确标注后的模型行为**

✅ **应该看到**:
- Agent大部分时间在前进
- 偶尔转头环视（1-2帧）
- 看到树后快速靠近
- 靠近后开始攻击

❌ **不应该看到**:
- 原地转圈超过2秒
- 长时间只调整视角不移动
- 来回摆头

---

### **标注质量指标**

| 指标 | 目标值 | 说明 |
|------|--------|------|
| P键使用率 | 30-50% | 策略质量中等 |
| 前进相关 | 50-70% | 主要行为 |
| 视角调整 | <15% | 辅助行为 |
| 连续相同视角调整 | <3帧 | 避免原地转 |

---

## 🎓 学习曲线

### **DAgger第1轮**
- BC基线差（IDLE 75%）
- 你的标注：60%修正，40% P键
- 结果：成功率40-50%

### **DAgger第2轮**
- 策略改善（IDLE 30%）
- 你的标注：40%修正，60% P键
- 结果：成功率60-70%

### **DAgger第3轮**
- 策略更好（IDLE 10%）
- 你的标注：20%修正，80% P键
- 结果：成功率80-90%

**关键**: P键使用率应该**随着迭代增加**！

---

## 🔧 调整你的标注策略

基于你的反馈，建议：

### **立即调整**

1. **回顾你已标注的数据**
```bash
# 检查你上一轮的标注
# 如果发现连续5个以上的视角调整，考虑重新标注
```

2. **重新标注（如果需要）**
```bash
# 删除质量差的标注
rm data/expert_labels/harvest_1_log/iter_1.pkl

# 重新标注，使用新策略
python tools/dagger/label_states.py \
    --states data/policy_states/harvest_1_log/iter_1 \
    --output data/expert_labels/harvest_1_log/iter_1.pkl \
    --smart-sampling
```

3. **使用"前进优先"原则**
```
看不到树？-> W (前进去找)
树在边缘？-> W (边走边看)
树在前方？-> W (靠近)
树很近？-> F 或 Q (攻击)
```

---

## 📚 推荐阅读

- `docs/guides/LABEL_STATES_GUIDE.md` - P键使用指南
- `docs/guides/DAGGER_QUICK_START.md` - DAgger快速开始

---

**版本**: 1.0.0  
**创建日期**: 2025-10-22  
**关键要点**: 环视是短期行为，移动是主要策略！


# Label States 标注工具快捷键指南

## 📋 概述

本文档说明了 DAgger 标注工具（`src/training/dagger/label_states.py`）的所有快捷键配置。

---

## 🎮 快捷键映射（新版）

### **基础移动控制**

| 按键 | 动作 | 说明 |
|------|------|------|
| `W` | 前进 | 向前移动 |
| `A` | 左移 | 向左平移 |
| `S` | 后退 | 向后移动 |
| `D` | 右移 | 向右平移 |

### **视角控制** ⭐ 改为方向键

| 按键 | 动作 | 说明 |
|------|------|------|
| `↑` (方向键上) | 向上看 | 抬头 |
| `↓` (方向键下) | 向下看 | 低头 |
| `←` (方向键左) | 向左看 | 转头向左 |
| `→` (方向键右) | 向右看 | 转头向右 |

### **基础动作**

| 按键 | 动作 | 说明 |
|------|------|------|
| `F` | 攻击 | 挖掘/砍树 |
| `Space` | 跳跃 | 向上跳 |

### **组合动作** ⭐ 新配置

| 按键 | 动作 | 说明 |
|------|------|------|
| `Q` | 前进 + 跳跃 | 跳跃前进（常用）⭐ |
| `E` | 前进 + 攻击 | 边走边砍（常用）⭐ |
| `R` | 前进 + 跳跃 + 攻击 | 全套组合 |

### **视角复位** ⭐ 新增

| 按键 | 动作 | 说明 |
|------|------|------|
| `P` | 视角置为中心 | 将 pitch 和 yaw 置为中心 (12, 12) ⭐ |

### **特殊操作** ⭐ 重要改动

| 按键 | 动作 | 说明 |
|------|------|------|
| `X` | 保持策略 | 认为策略动作正确，直接保存 ⭐ |
| `C` | 跳过状态 | 不标注此状态，跳到下一个 ⭐ |
| `Z` | 撤销标注 | 撤销上一个标注，回到上一个状态 ⭐ |
| `ESC` | 完成标注 | 保存所有标注并退出 |

---

## 🔄 主要变更对比

### **视角控制**
- ❌ 旧: `I/K/J/L` (上/下/左/右)
- ✅ 新: `↑/↓/←/→` (方向键) - 更直观！

### **组合动作**
- ❌ 旧: `Q` = 前进+攻击, `E` = 向上看+攻击
- ✅ 新: `Q` = 前进+跳跃, `E` = 前进+攻击 - 更常用！

### **特殊操作**
- ❌ 旧: `P` = 保持策略, `N` = 跳过, `X` = 退出
- ✅ 新: `X` = 保持策略, `C` = 跳过, `ESC` = 退出 - 更符合习惯！

---

## 🖼️ 界面改进

### **窗口尺寸**
- ❌ 旧: 640×480（太小）
- ✅ 新: **960×720**（更大更清晰）

### **显示内容**
1. **顶部信息框**
   - 进度：当前/总数
   - 优先级：HIGH/LOW
   - Episode 和 Step 信息
   - 策略动作描述

2. **底部快捷键说明** ⭐ 新增
   ```
   WASD: Move  |  Arrows: Look  |  F: Attack  |  Space: Jump
   Q: Fwd+Jump  |  E: Fwd+Attack  |  R: Fwd+Jump+Attack  |  P: Reset View
   X: Keep Policy  |  C: Skip  |  Z: Undo  |  ESC: Finish
   ```

---

## 🐛 Bug 修复

### **撤销标注错误**

**问题：**
```python
ValueError: The truth value of an array with more than one element is ambiguous
```

**原因：**
使用 `list.remove()` 比较包含 numpy 数组的字典时出错。

**解决：**
```python
# 旧代码（错误）
self.labeled_data.remove(removed)

# 新代码（正确）
self.labeled_data.pop()  # 直接删除最后一个
```

---

## 💡 使用建议

### **高效标注流程**

1. **快速判断**
   - 策略动作正确 → 按 `X` 保持
   - 需要纠正 → 按对应动作键
   - 不确定 → 按 `C` 跳过

2. **常用场景**
   - 砍树：多用 `E`（前进+攻击）
   - 跨越障碍：多用 `Q`（前进+跳跃）
   - 调整视角：用方向键（更直观）
   - 视角偏了：按 `P` 复位到中心（非常方便）⭐

3. **出错处理**
   - 标错了 → 按 `Z` 撤销（支持最多10次）
   - 想提前结束 → 按 `ESC`

---

## 🔧 技术细节

### **方向键键码**
OpenCV 中方向键的键码：
- `82`: ↑ (向上)
- `84`: ↓ (向下)
- `81`: ← (向左)
- `83`: → (向右)

### **动作编码**
MineDojo 使用 8 维 MultiDiscrete 动作空间：
```python
[forward/back, left/right, jump, pitch, yaw, functional, sprint, sneak]
```

示例：
- `[1, 0, 0, 12, 12, 0, 0, 0]` = 前进
- `[1, 0, 0, 12, 12, 3, 0, 0]` = 前进+攻击
- `[1, 0, 1, 12, 12, 0, 0, 0]` = 前进+跳跃

---

## 🧪 测试键码

如果需要测试按键码（调试用）：

```bash
python tools/test_key_codes.py
```

按任意键会显示其键码，用于验证方向键是否正确识别。

---

## 📖 相关文档

- [DAgger 完整指南](DAGGER_COMPREHENSIVE_GUIDE.md)
- [DAgger Workflow 跳过步骤指南](DAGGER_WORKFLOW_SKIP_GUIDE.md)
- [任务配置指南](GET_WOOD_CONFIG_GUIDE.md)

---

## 🎯 快速参考卡片

打印或保存这个卡片，标注时放在旁边参考：

```
┌─────────────────────────────────────────────┐
│  DAgger 标注快捷键                          │
├─────────────────────────────────────────────┤
│  移动: WASD                                 │
│  视角: ↑↓←→ 方向键                          │
│  动作: F(攻击) Space(跳跃)                  │
│                                             │
│  组合:                                      │
│    Q = 前进+跳跃   ⭐                        │
│    E = 前进+攻击   ⭐                        │
│    R = 前进+跳跃+攻击                        │
│                                             │
│  视角:                                      │
│    P = 视角复位 (12,12)   ⭐                │
│                                             │
│  操作:                                      │
│    X = 保持策略   ⭐                         │
│    C = 跳过       ⭐                         │
│    Z = 撤销       ⭐                         │
│    ESC = 完成                               │
└─────────────────────────────────────────────┘
```

---

## 📝 更新日志

**2025-10-25 (最新)**
- ✅ 新增按键 `P` 用于视角复位 (pitch=12, yaw=12)
- ✅ 支持 `--skip-collect` 跳过收集状态，直接进入标注流程
- ✅ Web UI 增加"重新标注"按钮，可清除指定迭代的标注数据

**2025-10-25 (之前)**
- ✅ 视角控制改为方向键（更直观）
- ✅ Q/E 快捷键重新分配（更符合常用场景）
- ✅ X/C 用于保持/跳过（更符合操作习惯）
- ✅ 窗口放大到 960×720
- ✅ 底部显示快捷键说明
- ✅ 修复撤销标注的 ValueError 错误
- ✅ 更新 workflow 脚本中的提示信息


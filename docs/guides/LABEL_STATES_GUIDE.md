# 📝 DAgger 状态标注指南

## 🎯 新增功能

### **1. P键 - 保持策略动作（认为当前策略是对的）⭐**

当你认为策略预测的动作是正确的时，按 **P** 键保持不变：

```
当前画面: 正对着树
策略动作: [1 0 0 12 12 3 0 0] (Forward + Attack)

你的判断: 策略动作正确！

按键: P

结果: ✓ [5/100] PASS (保持策略动作: Forward + Attack)
```

**何时使用**:
- ✅ 策略已经在正确地前进
- ✅ 策略正确地攻击树木
- ✅ 策略的视角调整合理
- ✅ 任何你认为策略做得对的情况

**优势**:
- 节省标注时间（不需要手动输入相同的动作）
- 标注速度提升50%+
- 减少误操作

---

### **2. 显示标注的新动作**

现在每次标注后，会显示你输入的完整动作描述：

```
# 示例1: 前进
按键: W
输出: ✓ [5/100] 前进 -> Forward

# 示例2: 前进+跳跃
按键: R  
输出: ✓ [6/100] 前进+跳跃 -> Forward + Jump

# 示例3: 前进+跳跃+攻击
按键: G
输出: ✓ [7/100] 前进+跳跃+攻击 -> Forward + Jump + Attack

# 示例4: 保持策略动作
按键: P
输出: ✓ [8/100] PASS (保持策略动作: Forward + Attack)
```

**好处**:
- ✅ 立即确认你的输入是否正确
- ✅ 发现错误可以马上用Z撤销
- ✅ 了解实际保存的动作内容

---

### **3. R键 - 前进+跳跃组合**

已经实现！按 **R** 键执行 **前进+跳跃**：

```
动作数组: [1, 0, 1, 12, 12, 0, 0, 0]
         前进 静止 跳跃  中心 中心  无   无  无
```

**其他组合键**:
- **Q**: 前进+攻击
- **E**: 向上看+攻击
- **R**: 前进+跳跃 ⭐
- **T**: 后退+跳跃
- **G**: 前进+跳跃+攻击

---

## 🎮 完整控制说明

### **移动控制**

| 按键 | 动作 | 数组 |
|------|------|------|
| W | 前进 | `[1, 0, 0, 12, 12, 0, 0, 0]` |
| S | 后退 | `[2, 0, 0, 12, 12, 0, 0, 0]` |
| A | 左移 | `[0, 1, 0, 12, 12, 0, 0, 0]` |
| D | 右移 | `[0, 2, 0, 12, 12, 0, 0, 0]` |

### **视角控制**

| 按键 | 动作 | 数组 |
|------|------|------|
| I | 向上看 | `[0, 0, 0, 8, 12, 0, 0, 0]` |
| K | 向下看 | `[0, 0, 0, 16, 12, 0, 0, 0]` |
| J | 向左看 | `[0, 0, 0, 12, 8, 0, 0, 0]` |
| L | 向右看 | `[0, 0, 0, 12, 16, 0, 0, 0]` |

### **动作**

| 按键 | 动作 | 数组 |
|------|------|------|
| F | 攻击（砍树） | `[0, 0, 0, 12, 12, 3, 0, 0]` |
| Space | 跳跃 | `[0, 0, 1, 12, 12, 0, 0, 0]` |

### **组合动作**

| 按键 | 动作 | 数组 |
|------|------|------|
| Q | 前进+攻击 | `[1, 0, 0, 12, 12, 3, 0, 0]` |
| E | 向上看+攻击 | `[0, 0, 0, 8, 12, 3, 0, 0]` |
| **R** | **前进+跳跃** ⭐ | `[1, 0, 1, 12, 12, 0, 0, 0]` |
| T | 后退+跳跃 | `[2, 0, 1, 12, 12, 0, 0, 0]` |
| G | 前进+跳跃+攻击 | `[1, 0, 1, 12, 12, 3, 0, 0]` |

### **特殊控制**

| 按键 | 功能 | 说明 |
|------|------|------|
| **P** | **保持策略动作** ⭐ | 认为当前策略是对的，不做修改 |
| N | 跳过此状态 | 不标注，直接跳过 |
| Z | 撤销上一个标注 | 最多撤销10步 |
| X / ESC | 完成标注 | 保存并退出 |

---

## 📊 实际使用示例

### **场景1: 策略表现良好**

```
Progress: 5/100 | Priority: HIGH
Episode: 2 | Step: 45
Policy Action: [1 0 0 12 12 3 0 0]
>>> Forward + Attack

画面: 正在向树前进并攻击
你的判断: ✅ 策略动作完全正确

按键: P

输出: ✓ [5/100] PASS (保持策略动作: Forward + Attack)
```

### **场景2: 需要跳跃靠近树**

```
Progress: 15/100 | Priority: HIGH  
Episode: 3 | Step: 20
Policy Action: [1 0 0 12 12 0 0 0]
>>> Forward

画面: 前方有个小坡，需要跳跃
你的判断: ❌ 应该前进+跳跃

按键: R

输出: ✓ [15/100] 前进+跳跃 -> Forward + Jump
```

### **场景3: 策略在IDLE，需要前进**

```
Progress: 25/100 | Priority: HIGH
Episode: 5 | Step: 10  
Policy Action: [0 0 0 12 12 0 0 0]
>>> IDLE

画面: 看到树了，但没有移动
你的判断: ❌ 应该前进

按键: W

输出: ✓ [25/100] 前进 -> Forward
```

### **场景4: 快速标注混合使用**

```
状态1: 策略=Forward, 你=P (保持) ✓
状态2: 策略=IDLE, 你=W (前进) ✓
状态3: 策略=Forward, 你=P (保持) ✓
状态4: 策略=Forward, 你=R (前进+跳跃) ✓
状态5: 策略=Attack, 你=Q (前进+攻击) ✓
状态6: 策略=Forward+Attack, 你=P (保持) ✓
```

**统计**:
- 总标注: 6个状态
- 使用P键: 3次（50%）
- 修改动作: 3次
- 平均每个状态: ~3秒（相比之前的5秒）

---

## 💡 标注技巧

### **技巧1: 善用P键**

**不好的做法**（标注慢）:
```
策略: Forward -> 你输入: W
策略: Forward -> 你输入: W  
策略: Attack -> 你输入: F
策略: Forward+Attack -> 你输入: Q
```

**好的做法**（标注快）:
```
策略: Forward -> 你输入: P ✓
策略: Forward -> 你输入: P ✓
策略: Attack -> 你输入: P ✓
策略: Forward+Attack -> 你输入: P ✓
```

**结果**: 速度提升3倍！

### **技巧2: 关注"高优先级"状态**

```
Priority: HIGH  <- 失败前的关键决策，仔细标注！
Priority: LOW   <- 成功episode的随机采样，可以快速用P
```

### **技巧3: 发现错误立即撤销**

```
✓ [10/100] 前进 -> Forward
✓ [11/100] 攻击 -> Attack
✓ [12/100] 前进 -> Forward  <- 哦不，应该是前进+跳跃！

按键: Z (撤销)
输出: ↶ 撤销标注 (剩余: 11)

按键: R (重新标注)
输出: ✓ [12/100] 前进+跳跃 -> Forward + Jump
```

### **技巧4: 批量标注相似状态**

如果连续多个状态都是相同的错误：
```
状态1: 策略=IDLE, 应该=前进 -> W
状态2: 策略=IDLE, 应该=前进 -> W  
状态3: 策略=IDLE, 应该=前进 -> W
状态4: 策略=Forward, 正确 -> P
状态5: 策略=Forward, 正确 -> P
```

找到模式后，快速输入！

---

## 🚀 使用流程

### **完整DAgger流程**

```bash
# 1. 收集策略状态
bash scripts/run_minedojo_x86.sh python tools/dagger/run_policy_collect_states.py \
    --model checkpoints/dagger/harvest_1_log/bc_baseline.zip \
    --episodes 20 \
    --output data/policy_states/harvest_1_log/iter_1

# 2. 标注状态（使用新功能）
bash scripts/run_minedojo_x86.sh python tools/dagger/label_states.py \
    --states data/policy_states/harvest_1_log/iter_1 \
    --output data/expert_labels/harvest_1_log/iter_1.pkl \
    --smart-sampling

# 3. 训练DAgger
bash scripts/run_minedojo_x86.sh python src/training/train_dagger.py \
    --base-data data/expert_demos/harvest_1_log \
    --new-labels data/expert_labels/harvest_1_log/iter_1.pkl \
    --output checkpoints/dagger/harvest_1_log/dagger_iter_1.zip
```

### **或使用自动化脚本**

```bash
bash scripts/run_dagger_workflow.sh \
    --task harvest_1_log \
    --skip-recording \
    --skip-bc \
    --iterations 3
```

---

## 📈 预期效果

### **标注速度对比**

| 方法 | 每个状态耗时 | 100个状态总时间 |
|------|------------|----------------|
| 之前（全手动） | ~5秒 | ~8.3分钟 |
| 现在（使用P键） | ~2秒 | ~3.3分钟 |
| 提升 | **60%** | **60%** |

### **标注准确性**

- ✅ 立即看到标注的动作描述
- ✅ 发现错误可以马上撤销
- ✅ 减少输入错误（P键替代手动输入）

---

## 🎓 最佳实践

### **1. 预先计划**

标注前先快速浏览一遍：
```bash
# 查看有多少状态需要标注
ls data/policy_states/harvest_1_log/iter_1/
```

### **2. 分批标注**

如果状态很多（>100个）：
```bash
# 今天标注50个
python tools/dagger/label_states.py ... 
# 标注到一半按X保存

# 明天继续（会跳过已标注的）
python tools/dagger/label_states.py ...
```

### **3. 休息一下**

每标注50个状态，休息5分钟，保持专注！

### **4. 验证标注**

```bash
# 训练后立即评估
bash scripts/run_minedojo_x86.sh python tools/dagger/evaluate_policy.py \
    --model checkpoints/dagger/harvest_1_log/dagger_iter_1.zip \
    --episodes 20
```

如果成功率没提升，可能标注质量有问题。

---

## 🔍 故障排查

### **问题1: P键没反应**

确保OpenCV窗口有焦点：
- 点击一下窗口
- 确保窗口在最前

### **问题2: 显示的动作不对**

检查是否按对了键：
- R = 前进+跳跃
- T = 后退+跳跃
- G = 前进+跳跃+攻击

### **问题3: 标注速度还是慢**

检查你的P键使用率：
```
# 理想情况
P键使用: 40-60%
其他键: 40-60%

# 如果P键<20%
说明策略质量很差，需要更多轮DAgger
```

---

**版本**: 2.0.0  
**更新日期**: 2025-10-22  
**新增功能**: P键保持策略、显示标注动作、R键前进+跳跃

